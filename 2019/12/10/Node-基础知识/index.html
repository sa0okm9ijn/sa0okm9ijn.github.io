
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  
    <title>Node-基础知识 | 110laile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="110laile">
    

    
    <meta name="description" content="node.js介绍node.js他是用C++开发的一种运行于服务器端的语言，可以写网站后台程序，可以做服务端应用开发，他的语法就是JAVASCRIPT，会JS，就是会node.js Node 是一个让 JavaScript 运行在服务端的开发平台，它让 JavaScript 成为与PHP、Python、Perl、Ruby 等服务端语言平起平坐的脚本语言。 Node.js是目前非常火热的技术，但是它">
<meta name="keywords" content="JavaScript,node">
<meta property="og:type" content="article">
<meta property="og:title" content="Node-基础知识">
<meta property="og:url" content="http://yoursite.com/2019/12/10/Node-基础知识/index.html">
<meta property="og:site_name" content="110laile">
<meta property="og:description" content="node.js介绍node.js他是用C++开发的一种运行于服务器端的语言，可以写网站后台程序，可以做服务端应用开发，他的语法就是JAVASCRIPT，会JS，就是会node.js Node 是一个让 JavaScript 运行在服务端的开发平台，它让 JavaScript 成为与PHP、Python、Perl、Ruby 等服务端语言平起平坐的脚本语言。 Node.js是目前非常火热的技术，但是它">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-01-09T10:36:52.308Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Node-基础知识">
<meta name="twitter:description" content="node.js介绍node.js他是用C++开发的一种运行于服务器端的语言，可以写网站后台程序，可以做服务端应用开发，他的语法就是JAVASCRIPT，会JS，就是会node.js Node 是一个让 JavaScript 运行在服务端的开发平台，它让 JavaScript 成为与PHP、Python、Perl、Ruby 等服务端语言平起平坐的脚本语言。 Node.js是目前非常火热的技术，但是它">

    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="110laile" title="110laile"></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="110laile">110laile</a></h1>
				<h2 class="blog-motto">个人技术博客</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索">
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</ul></nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/12/10/Node-基础知识/" title="Node-基础知识" itemprop="url">Node-基础知识</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="110laile" target="_blank" itemprop="author">110laile</a>
		
  </p><p class="article-time">
    <time datetime="2019-12-10T07:01:37.000Z" itemprop="datePublished"> 发表于 2019-12-10</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#node-js介绍"><span class="toc-number">1.</span> <span class="toc-text">node.js介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装node-js"><span class="toc-number">2.</span> <span class="toc-text">安装node.js</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#npm"><span class="toc-number">3.</span> <span class="toc-text">npm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#js模块化"><span class="toc-number">4.</span> <span class="toc-text">js模块化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonJs"><span class="toc-number">4.1.</span> <span class="toc-text">CommonJs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AMD"><span class="toc-number">4.2.</span> <span class="toc-text">AMD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CMD"><span class="toc-number">4.3.</span> <span class="toc-text">CMD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Es6"><span class="toc-number">4.4.</span> <span class="toc-text">Es6</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#css模块化-预处理器less"><span class="toc-number">5.</span> <span class="toc-text">css模块化(预处理器less)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在浏览器中使用less"><span class="toc-number">5.1.</span> <span class="toc-text">在浏览器中使用less</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在node中使用less"><span class="toc-number">5.2.</span> <span class="toc-text">在node中使用less</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#less基本语法"><span class="toc-number">5.3.</span> <span class="toc-text">less基本语法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#全局对象和全局变量"><span class="toc-number">6.</span> <span class="toc-text">全局对象和全局变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异步操作"><span class="toc-number">7.</span> <span class="toc-text">异步操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#js执行环境判断"><span class="toc-number">8.</span> <span class="toc-text">js执行环境判断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本模块"><span class="toc-number">9.</span> <span class="toc-text">基本模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fs模块"><span class="toc-number">9.1.</span> <span class="toc-text">fs模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http模块"><span class="toc-number">9.2.</span> <span class="toc-text">http模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#crypto模块"><span class="toc-number">9.3.</span> <span class="toc-text">crypto模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web开发"><span class="toc-number">10.</span> <span class="toc-text">Web开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#koa-Web框架"><span class="toc-number">10.1.</span> <span class="toc-text">koa Web框架</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建Koa工程"><span class="toc-number">10.1.1.</span> <span class="toc-text">创建Koa工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#处理url"><span class="toc-number">10.1.2.</span> <span class="toc-text">处理url</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用Nunjucks"><span class="toc-number">10.1.3.</span> <span class="toc-text">使用Nunjucks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MVC"><span class="toc-number">10.1.4.</span> <span class="toc-text">MVC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql"><span class="toc-number">10.2.</span> <span class="toc-text">mysql</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Sequelize"><span class="toc-number">10.2.1.</span> <span class="toc-text">Sequelize</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#规范化Model"><span class="toc-number">10.2.2.</span> <span class="toc-text">规范化Model</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mocha"><span class="toc-number">10.3.</span> <span class="toc-text">mocha</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#编写测试"><span class="toc-number">10.3.1.</span> <span class="toc-text">编写测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步测试"><span class="toc-number">10.3.2.</span> <span class="toc-text">异步测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Http测试"><span class="toc-number">10.3.3.</span> <span class="toc-text">Http测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行测试"><span class="toc-number">10.3.4.</span> <span class="toc-text">运行测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#webSocket"><span class="toc-number">10.4.</span> <span class="toc-text">webSocket</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ws模块"><span class="toc-number">10.4.1.</span> <span class="toc-text">ws模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mvc中集成websocket"><span class="toc-number">10.4.2.</span> <span class="toc-text">mvc中集成websocket</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#REST"><span class="toc-number">10.5.</span> <span class="toc-text">REST</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#koa处理REST"><span class="toc-number">10.5.1.</span> <span class="toc-text">koa处理REST</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#webpack"><span class="toc-number">11.</span> <span class="toc-text">webpack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#webpack核心概念"><span class="toc-number">11.1.</span> <span class="toc-text">webpack核心概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常用插件及loader"><span class="toc-number">11.2.</span> <span class="toc-text">常用插件及loader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#出入口、loader、插件"><span class="toc-number">11.3.</span> <span class="toc-text">出入口、loader、插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#js-tree-shaking"><span class="toc-number">11.4.</span> <span class="toc-text">js tree shaking</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#css-tree-shaking"><span class="toc-number">11.5.</span> <span class="toc-text">css tree shaking</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#postcss"><span class="toc-number">11.6.</span> <span class="toc-text">postcss</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#htmlwebpackplugin"><span class="toc-number">11.7.</span> <span class="toc-text">htmlwebpackplugin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#提取公共js代码"><span class="toc-number">11.8.</span> <span class="toc-text">提取公共js代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#图片处理"><span class="toc-number">11.9.</span> <span class="toc-text">图片处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开启本地服务器"><span class="toc-number">11.10.</span> <span class="toc-text">开启本地服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#热更新"><span class="toc-number">11.11.</span> <span class="toc-text">热更新</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gulp"><span class="toc-number">12.</span> <span class="toc-text">gulp</span></a></li></ol>
		
		</div>
		
		<h2 id="node-js介绍"><a href="#node-js介绍" class="headerlink" title="node.js介绍"></a>node.js介绍</h2><p>node.js他是用C++开发的一种运行于服务器端的语言，可以写网站后台程序，可以做服务端应用开发，他的语法就是JAVASCRIPT，会JS，就是会node.js</p>
<p>Node 是一个让 JavaScript 运行在服务端的开发平台，它让 JavaScript 成为与PHP、Python、Perl、Ruby 等服务端语言平起平坐的脚本语言。</p>
<p>Node.js是目前非常火热的技术，但是它的诞生经历却很奇特。</p>
<p>众所周知，在Netscape设计出JavaScript后的短短几个月，JavaScript事实上已经是前端开发的唯一标准。</p>
<p>后来，微软通过IE击败了Netscape后一统桌面，结果几年时间，浏览器毫无进步。（2001年推出的古老的IE 6到今天仍然有人在使用！）</p>
<p>没有竞争就没有发展。微软认为IE6浏览器已经非常完善，几乎没有可改进之处，然后解散了IE6开发团队！而Google却认为支持现代Web应用的新一代浏览器才刚刚起步，尤其是浏览器负责运行JavaScript的引擎性能还可提升10倍。</p>
<p>先是Mozilla借助已壮烈牺牲的Netscape遗产在2002年推出了Firefox浏览器，紧接着Apple于2003年在开源的KHTML浏览器的基础上推出了WebKit内核的Safari浏览器，不过仅限于Mac平台。</p>
<p>随后，Google也开始创建自家的浏览器。他们也看中了WebKit内核，于是基于WebKit内核推出了Chrome浏览器。</p>
<p>Chrome浏览器是跨Windows和Mac平台的，并且，Google认为要运行现代Web应用，浏览器必须有一个性能非常强劲的JavaScript引擎，于是Google自己开发了一个高性能JavaScript引擎，名字叫V8，以BSD许可证开源。</p>
<p>现代浏览器大战让微软的IE浏览器远远地落后了，因为他们解散了最有经验、战斗力最强的浏览器团队！回过头再追赶却发现，支持HTML5的WebKit已经成为手机端的标准了，IE浏览器从此与主流移动端设备绝缘。</p>
<p>浏览器大战和Node有何关系？</p>
<p>话说有个叫Ryan Dahl的歪果仁，他的工作是用C/C++写高性能Web服务。对于高性能，异步IO、事件驱动是基本原则，但是用C/C++写就太痛苦了。于是这位仁兄开始设想用高级语言开发Web服务。他评估了很多种高级语言，发现很多语言虽然同时提供了同步IO和异步IO，但是开发人员一旦用了同步IO，他们就再也懒得写异步IO了，所以，最终，Ryan瞄向了JavaScript。</p>
<p>因为JavaScript是单线程执行，根本不能进行同步IO操作，所以，JavaScript的这一“缺陷”导致了它只能使用异步IO。</p>
<p>选定了开发语言，还要有运行时引擎。这位仁兄曾考虑过自己写一个，不过明智地放弃了，因为V8就是开源的JavaScript引擎。让Google投资去优化V8，咱只负责改造一下拿来用，还不用付钱，这个买卖很划算。</p>
<p>于是在2009年，Ryan正式推出了基于JavaScript语言和V8引擎的开源Web服务器项目，命名为Node.js。虽然名字很土，但是，Node第一次把JavaScript带入到后端服务器开发，加上世界上已经有无数的JavaScript开发人员，所以Node一下子就火了起来。</p>
<p>在Node上运行的JavaScript相比其他后端开发语言有何优势？</p>
<p>最大的优势是借助JavaScript天生的事件驱动机制加V8高性能引擎，使编写高性能Web服务轻而易举。</p>
<p>其次，JavaScript语言本身是完善的函数式语言，在前端开发时，开发人员往往写得比较随意，让人感觉JavaScript就是个“玩具语言”。但是，在Node环境下，通过模块化的JavaScript代码，加上函数式编程，并且无需考虑浏览器兼容性问题，直接使用最新的ECMAScript 6标准，可以完全满足工程上的需求。</p>
<p><code>我还听说过io.js，这又是什么鬼</code></p>
<p>因为Node.js是开源项目，虽然由社区推动，但幕后一直由Joyent公司资助。由于一群开发者对Joyent公司的策略不满，于2014年从Node.js项目fork出了io.js项目，决定单独发展，但两者实际上是兼容的。</p>
<p>然而中国有句古话，叫做“分久必合，合久必分”。分家后没多久，Joyent公司表示要和解，于是，io.js项目又决定回归Node.js。</p>
<p>具体做法是将来io.js将首先添加新的特性，如果大家测试用得爽，就把新特性加入Node.js。io.js是“尝鲜版”，而Node.js是线上稳定版，相当于Fedora Linux和RHEL的关系。</p>
<p>本章教程的所有代码都在Node.js上调试通过。如果你要尝试io.js也是可以的，不过两者如果遇到一些区别请自行查看io.js的文档。</p>
<h2 id="安装node-js"><a href="#安装node-js" class="headerlink" title="安装node.js"></a>安装node.js</h2><p>由于Node.js平台是在后端运行JavaScript代码，所以，必须首先在本机安装Node环境。</p>
<p>下载地址<a href="https://nodejs.org/en/" target="_blank" rel="noopener">https://nodejs.org/en/</a></p>
<p>在Windows上安装时务必选择全部组件，包括勾选Add to Path。</p>
<p>安装完成,cmd下输入如下,即安装完成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br><span class="line">v10.16.3</span><br></pre></td></tr></table></figure>
<h2 id="npm"><a href="#npm" class="headerlink" title="npm"></a>npm</h2><p>npm是什么东东？npm其实是Node.js的包管理工具,类似c#的nug等,在安装node的时候已经默认安装好了</p>
<p>以前我的JS，CSS，HTML文件分开写,也没什么问题,可是着前端的发展，社区的壮大，各种前端的库和框架层出不穷，我们项目中可能会使用很多额外的库，如何有效管理这些引入的库文件是一个大问题，而且我们知道基于在HTML中使用<code>&lt;script&gt;</code>引入的方式，有两个弊端，一个是会重复引入，二是当库文件数量很多时管理成为一个大难题。面对这样的局面，为了简化开发的复杂度，前端社区涌现了很多实践方法。模块化就是其中一项成功实践,而npm就是这样在node社区中产生的</p>
<p>为啥我们需要一个包管理工具呢？因为我们在Node.js上开发时，会用到很多别人写的JavaScript代码。如果我们要使用别人写的某个包，每次都根据名称搜索一下官方网站，下载代码，解压，再使用，非常繁琐。于是一个集中管理的工具应运而生：大家都把自己开发的模块打包后放到npm官网上，如果要使用，直接通过npm安装就可以直接用，不用管代码存在哪，应该从哪下载。</p>
<p>更重要的是，如果我们要使用模块A，而模块A又依赖于模块B，模块B又依赖于模块X和模块Y，npm可以根据依赖关系，把所有依赖的包都下载下来并管理起来。否则，靠我们自己手动管理，肯定既麻烦又容易出错。</p>
<p>讲了这么多，npm究竟在哪？</p>
<p>其实npm已经在Node.js安装的时候顺带装好了。我们在命令提示符或者终端输入npm -v，应该看到类似的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm -v</span><br><span class="line">6.9.0</span><br></pre></td></tr></table></figure>
<h2 id="js模块化"><a href="#js模块化" class="headerlink" title="js模块化"></a>js模块化</h2><p>我们平常的开发中主要用以下几种方式开发,来做到代码的高内聚,低耦合,以及代码的复用、避免变量的命名冲突等问题.</p>
<ol>
<li><p>函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindEvent</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>命名空间</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj1=&#123;</span><br><span class="line">    a:<span class="number">1</span>,</span><br><span class="line">    b:<span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>闭包</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a =<span class="number">123</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="attr">foo</span>:foo&#125;;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
</li>
<li><p>模式增强</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">$</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a =<span class="number">123</span>;</span><br><span class="line">    <span class="comment">//$ 模式增强</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="attr">foo</span>:foo&#125;;</span><br><span class="line">&#125;)(jQuery)</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们需要的一些特定功能,比如轮播图单独写的js,我们按照一定依赖顺序引入js文件</p>
</li>
</ol>
<p>上面种种都体现了模块化的思想,但是都不完美、不完善,没有一套关于模块化的规范,随着nodejs的出现,有了commonjs规范(模块化的规范),在nodejs里实现了commonjs的规范</p>
<p>模块化的规范主要有commonjs、amd、cmd、es6</p>
<h3 id="CommonJs"><a href="#CommonJs" class="headerlink" title="CommonJs"></a>CommonJs</h3><ul>
<li><p>每个文件就是一个模块，有自己的作用域。在一个文件里面定义的变量、函数、类，都是私有的，对其他文件不可见。</p>
</li>
<li><p>CommonJS规范规定，每个模块内部，module变量代表当前模块。这个变量是一个对象，它的exports属性（即module.exports）是对外的接口。加载某个模块，其实是加载该模块的module.exports属性。</p>
</li>
<li><p>require方法用于加载模块。</p>
</li>
<li><p>模块可以多次加载，但是只会在第一次加载时运行一次，然后运行结果就被缓存了，以后再加载，就直接读取缓存结果。要想让模块再次运行，必须清除缓存。</p>
</li>
<li><p>Node内部提供一个Module构建函数。所有模块都是Module的实例。每个模块内部，都有一个module对象，代表当前模块。</p>
</li>
<li><p>如果在命令行下调用某个模块，比如node something.js，那么module.parent就是null。如果是在脚本之中调用，比如require(‘./something.js’)，那么module.parent就是调用它的模块。利用这一点，可以判断当前模块是否为入口脚本。</p>
</li>
<li><p>为了方便，Node为每个模块提供一个exports变量，指向module.exports。这等同在每个模块头部，有一行这样的命令。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> exports = <span class="built_in">module</span>.exports;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>注意，不能直接将exports变量指向一个值，因为这样等于切断了exports与module.exports的联系。<br>如果你觉得，exports与module.exports之间的区别很难分清，一个简单的处理方法，就是放弃使用exports，只使用module.exports。</p>
<p>示例如下,此处示例为node环境下执行,如果需要在浏览器执行需要工具转化<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// commonjs/</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- modules/</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- m1.js &lt;-- 模块1</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- m2.js &lt;-- 模块2</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- m3.js &lt;-- 模块3</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- index.js &lt;-- 使用koa的js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//m1.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    msg: <span class="string">"m1"</span>,</span><br><span class="line">    foo: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//m2.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'m2'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//m3.js</span></span><br><span class="line">exports.foo = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'m3'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//index.js</span></span><br><span class="line"><span class="keyword">var</span> m1 = <span class="built_in">require</span>(<span class="string">'./modules/m1'</span>);</span><br><span class="line"><span class="keyword">var</span> m2 = <span class="built_in">require</span>(<span class="string">'./modules/m2'</span>);</span><br><span class="line"><span class="keyword">var</span> m3 = <span class="built_in">require</span>(<span class="string">'./modules/m3'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(m1.foo());</span><br><span class="line"><span class="built_in">console</span>.log(m2());</span><br><span class="line"><span class="built_in">console</span>.log(m3.foo());</span><br></pre></td></tr></table></figure></p>
<h3 id="AMD"><a href="#AMD" class="headerlink" title="AMD"></a>AMD</h3><p>CommonJs为服务端而生,采用同步加载方式,因此不适用浏览器端.<br>AMD规范则是异步加载模块,允许调用指定回调函数</p>
<ul>
<li>使用define定义一个模块,使用require来加载一个模块<code>define(moduleId,[&#39;module1&#39;,&#39;module2&#39;],function(m1,m2){})</code></li>
<li>使用依赖require.js</li>
<li>依赖前置</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// commonjs/</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- libs/</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- jquery-3.4.1.min.js &lt;-- jquery</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- require.js &lt;-- requery</span></span><br><span class="line"><span class="comment">// +- modules/</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- m1.js &lt;-- m1</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- m2.js &lt;-- m1</span></span><br><span class="line"><span class="comment">// +- demo.js &lt;-- 使用koa的js</span></span><br><span class="line"><span class="comment">// +- demo.html</span></span><br><span class="line"><span class="comment">//m1.js</span></span><br><span class="line">define(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name = <span class="string">'m1-amd'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        getName</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//m2.js</span></span><br><span class="line">define([<span class="string">'m1'</span>], <span class="function"><span class="keyword">function</span> (<span class="params">m1</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="string">'m2-amd'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(msg, m1.getName());</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        show</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//demo.js</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>.config(&#123;</span><br><span class="line">        paths: &#123;</span><br><span class="line">            m2: <span class="string">'./modules/m2'</span>,</span><br><span class="line">            m1: <span class="string">'./modules/m1'</span>,</span><br><span class="line">            jquery: <span class="string">'./libs/jquery-3.4.1.min'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//此处jquery为jquery暴露的名称不可更改</span></span><br><span class="line">    <span class="built_in">require</span>([<span class="string">'m2'</span>, <span class="string">'jquery'</span>], <span class="function"><span class="keyword">function</span> (<span class="params">m2, $</span>) </span>&#123;</span><br><span class="line">        m2.show();</span><br><span class="line">        $(<span class="string">'body'</span>).css(<span class="string">'backgroundColor'</span>, <span class="string">'#000'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)()</span><br><span class="line"><span class="comment">//demo.html</span></span><br><span class="line">&lt;script src=<span class="string">"./libs/require.js"</span> data-main=<span class="string">"./demo.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="comment">//require.js在加载的时候会检查data-main属性，当加载完毕，data-main属性规定的js文件会第一个被require.js加载并执行</span></span><br></pre></td></tr></table></figure>
<h3 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h3><p>CMD异步加载,跟AMD的主要区别在于,AMD依赖前置,提前加载依赖.而CMD就近加载,按需加载</p>
<ul>
<li>使用define定义一个模块,使用require来加载一个模块<code>define(function(require,exports,module){})</code></li>
<li>使用依赖sea.js</li>
<li>就近加载,按需加载</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// commonjs/</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- modules/</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- m1.js &lt;-- m1</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- m2.js &lt;-- m1</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- m3.js &lt;-- m1</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- m4.js &lt;-- m1</span></span><br><span class="line"><span class="comment">// +- app.js &lt;-- 使用koa的js</span></span><br><span class="line"><span class="comment">// +- index.html</span></span><br><span class="line"><span class="comment">// +- sea.js</span></span><br><span class="line"><span class="comment">//m1.js</span></span><br><span class="line">define(<span class="function"><span class="keyword">function</span> (<span class="params">require, exports, module</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="string">"m1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">module</span>.exports = &#123;</span><br><span class="line">        foo: foo</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//m2.js</span></span><br><span class="line">define(<span class="function"><span class="keyword">function</span> (<span class="params">require, exports, module</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="string">"m2"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">module</span>.exports = bar;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//m3.js</span></span><br><span class="line">define(<span class="function"><span class="keyword">function</span> (<span class="params">require, exports, module</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="string">"m3"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    exports.m3 = foo;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//m4.js</span></span><br><span class="line">define(<span class="function"><span class="keyword">function</span> (<span class="params">require, exports, module</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> msg = <span class="string">'m4'</span>;</span><br><span class="line">    <span class="comment">//同步加载</span></span><br><span class="line">    <span class="keyword">var</span> m2 = <span class="built_in">require</span>(<span class="string">'./m2'</span>);</span><br><span class="line">    m2();</span><br><span class="line">    <span class="comment">//异步加载</span></span><br><span class="line">    <span class="built_in">require</span>.async(<span class="string">'./m3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">m3</span>) </span>&#123;</span><br><span class="line">        m3.m3();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fun</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(msg);</span><br><span class="line">    &#125;;</span><br><span class="line">    exports.m4 = fun;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//app.js</span></span><br><span class="line">define(<span class="function"><span class="keyword">function</span> (<span class="params">require, exports, module</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> m1 = <span class="built_in">require</span>(<span class="string">'/modules/m1'</span>);</span><br><span class="line">    m1.foo();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> m4 = <span class="built_in">require</span>(<span class="string">'/modules/m4'</span>);</span><br><span class="line">    m4.m4();</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//index.html</span></span><br><span class="line">    &lt;script src=<span class="string">"./sea.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        seajs.use(<span class="string">'./app.js'</span>);</span><br><span class="line">    &lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Es6"><a href="#Es6" class="headerlink" title="Es6"></a>Es6</h3><p>ES6自带模块化,可以使用import引入模块,export导出模块</p>
<ul>
<li><p>导出</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//暴漏变量</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">var</span> a= <span class="string">'123'</span>;</span><br><span class="line"><span class="comment">//暴漏函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">myFun</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="comment">//默认暴漏变量函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> a=<span class="string">'123'</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">myFun</span>(<span class="params"></span>)</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>导入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;m1,m2&#125; <span class="keyword">from</span> <span class="string">'lib'</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="css模块化-预处理器less"><a href="#css模块化-预处理器less" class="headerlink" title="css模块化(预处理器less)"></a>css模块化(预处理器less)</h2><p>less是一门向后兼容的css扩展语言,是一种动式的语言,属于css预处理语言的一种</p>
<h3 id="在浏览器中使用less"><a href="#在浏览器中使用less" class="headerlink" title="在浏览器中使用less"></a>在浏览器中使用less</h3><p>在浏览器中使用less,需要less.js的支持,并且必须式http协议打开的网页,文件协议打开的会报错<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet/less"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"./index.less"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"//cdnjs.cloudflare.com/ajax/libs/less.js/2.5.3/less.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="在node中使用less"><a href="#在node中使用less" class="headerlink" title="在node中使用less"></a>在node中使用less</h3><p>在node中使用less,即把less文件编译成浏览器支持的css文件,安装less<code>npm install -g less</code>,编译<code>lessc index.less &gt; index.css</code>,即编译成了浏览器支持的css文件</p>
<h3 id="less基本语法"><a href="#less基本语法" class="headerlink" title="less基本语法"></a>less基本语法</h3><ul>
<li><p>嵌套</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="selector-class">.wrapper</span> &#123;</span><br><span class="line">        <span class="selector-class">.box</span> &#123;</span><br><span class="line">            <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">            <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">            <span class="attribute">border-bottom</span>: solid <span class="number">1px</span> red;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>变量及变量运算</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@color:</span> blue;</span><br><span class="line"><span class="variable">@w:</span> <span class="number">400px</span>;</span><br><span class="line"><span class="variable">@h:</span> <span class="variable">@w</span>+<span class="number">100px</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="variable">@w</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="variable">@h</span>;</span><br><span class="line">    <span class="attribute">border-bottom</span>: solid <span class="number">1px</span> <span class="variable">@color</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>作用域</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="variable">@size:</span><span class="number">10px</span>;</span><br><span class="line">    <span class="selector-class">.wrapper</span> &#123;</span><br><span class="line">        <span class="variable">@size:</span><span class="number">15px</span>;</span><br><span class="line">        <span class="selector-class">.box</span> &#123;</span><br><span class="line">            <span class="variable">@size:</span><span class="number">20px</span>;</span><br><span class="line">            <span class="attribute">font-size</span>: <span class="variable">@size</span>;<span class="comment">//输出20px</span></span><br><span class="line">            <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">            <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">            <span class="attribute">border-bottom</span>: solid <span class="number">1px</span> red;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>作用域的延迟加载</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="variable">@size:</span><span class="number">10px</span>;</span><br><span class="line">    <span class="selector-class">.wrapper</span> &#123;</span><br><span class="line">        <span class="variable">@size:</span><span class="number">15px</span>;</span><br><span class="line">        <span class="selector-class">.box</span> &#123;</span><br><span class="line">            <span class="variable">@size:</span><span class="number">20px</span>;</span><br><span class="line">            <span class="attribute">font-size</span>: <span class="variable">@size</span>;<span class="comment">//输出25px</span></span><br><span class="line">            <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">            <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">            <span class="variable">@size:</span><span class="number">25px</span>;</span><br><span class="line">            <span class="attribute">border-bottom</span>: solid <span class="number">1px</span> red;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>混合 将相同样式抽离 从一个规则引入到另一个规则集的方式</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.border</span>&#123;</span><br><span class="line">    <span class="attribute">border-top</span>: <span class="number">1px</span> solid red;</span><br><span class="line">    <span class="attribute">border-bottom</span>:  <span class="number">1px</span> solid blue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="selector-class">.wrapper</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">        <span class="selector-class">.border</span>;</span><br><span class="line">        <span class="selector-class">.box</span> &#123;</span><br><span class="line">            <span class="attribute">margin-top</span>: <span class="number">50px</span>;</span><br><span class="line">            <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">            <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">            <span class="selector-class">.border</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>混合 带变量及默认值的混合 </p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.border</span>(<span class="variable">@width</span>:<span class="number">5px</span>,<span class="variable">@c</span>:<span class="number">#ccc</span>)&#123;</span><br><span class="line">    <span class="attribute">border</span>:<span class="variable">@width</span> solid <span class="variable">@c</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="selector-class">.wrapper</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">        <span class="selector-class">.border</span>();</span><br><span class="line">        <span class="selector-class">.box</span> &#123;</span><br><span class="line">            <span class="attribute">margin-top</span>: <span class="number">50px</span>;</span><br><span class="line">            <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">            <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">            <span class="selector-class">.border</span>(<span class="number">3px</span>,<span class="number">#dd0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>模块引入</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@import</span> <span class="string">'./trangle.less'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>arguments</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.border</span>(<span class="variable">@w</span>,<span class="variable">@s</span>,<span class="variable">@c</span>)&#123;</span><br><span class="line">    <span class="attribute">border</span>:<span class="variable">@arguments</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.box</span>&#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">    <span class="selector-class">.border</span>(<span class="number">1px</span>,solid,<span class="number">#000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>匹配</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.trangle</span>(B, <span class="variable">@color</span>, <span class="variable">@w</span>) &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">border-width</span>: <span class="variable">@w</span>;</span><br><span class="line">    <span class="attribute">border-style</span>: solid;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="variable">@color</span> transparent transparent transparent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.trangle</span>(T, <span class="variable">@color</span>, <span class="variable">@w</span>) &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">border-width</span>: <span class="variable">@w</span>;</span><br><span class="line">    <span class="attribute">border-style</span>: solid;</span><br><span class="line">    <span class="attribute">border-color</span>: transparent transparent <span class="variable">@color</span> transparent;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="selector-class">.box</span> &#123;</span><br><span class="line">        <span class="comment">//匹配</span></span><br><span class="line">        <span class="selector-class">.trangle</span>(T,blue,<span class="number">40px</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="全局对象和全局变量"><a href="#全局对象和全局变量" class="headerlink" title="全局对象和全局变量"></a>全局对象和全局变量</h2><p>因为Node.js是运行在服务区端的JavaScript环境，服务器程序和浏览器程序相比，最大的特点是没有浏览器的安全限制了，而且，服务器程序必须能接收网络请求，读写文件，处理二进制内容，所以，Node.js内置的常用模块就是为了实现基本的服务器功能。这些模块在浏览器环境中是无法被执行的，因为它们的底层代码是用C/C++在Node.js运行环境中实现的。</p>
<p>在前面的JavaScript课程中，我们已经知道，JavaScript有且仅有一个全局对象，在浏览器中，叫window对象。而在Node.js环境中，也有唯一的全局对象，但不叫window，而叫global，这个对象的属性和方法也和浏览器环境的window不同。</p>
<ul>
<li>global</li>
</ul>
<p>表示Node所在的全局环境，类似于浏览器的window对象。需要注意的是，如果在浏览器中声明一个全局变量，实际上是声明了一个全局对象的属性，比如var x = 1等同于设置window.x = 1，但是Node不是这样，至少在模块中不是这样（REPL环境的行为与浏览器一致）。在模块文件中，声明var x = 1，该变量不是global对象的属性，global.x等于undefined。这是因为模块的全局变量都是该模块私有的，其他模块无法取到。</p>
<ul>
<li>process</li>
</ul>
<p>该对象表示Node所处的当前进程，允许开发者与该进程互动。<code>process === global.process</code></p>
<ul>
<li>console</li>
</ul>
<p>指向Node内置的console模块，提供命令行环境中的标准输入、标准输出功能。<code>console === global.console</code></p>
<h2 id="异步操作"><a href="#异步操作" class="headerlink" title="异步操作"></a>异步操作</h2><p>Node采用V8引擎处理JavaScript脚本，最大特点就是单线程运行，一次只能运行一个任务。这导致Node大量采用异步操作（asynchronous operation），即任务不是马上执行，而是插在任务队列的尾部，等到前面的任务运行完后再执行。</p>
<p>由于这种特性，某一个任务的后续操作，往往采用回调函数（callback）的形式进行定义。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"nextTick was set!"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//node退出执行</span></span><br><span class="line">process.on(<span class="string">'exit'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">code</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'about to exit with code:'</span> + code);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//本轮不执行,等到主线程走完下一轮事件循环才执行</span></span><br><span class="line"></span><br><span class="line">process.nextTick(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"nextTick callback"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">=&gt;</span><br><span class="line">nextTick was <span class="keyword">set</span>!</span><br><span class="line">nextTick callback</span><br><span class="line">about to exit with code:0</span><br></pre></td></tr></table></figure>
<p>由于Node环境执行的JavaScript代码是服务器端代码，所以，绝大部分需要在服务器运行期反复执行业务逻辑的代码，必须使用异步代码，否则，同步代码在执行时期，服务器将停止响应，因为JavaScript只有一个执行线程。</p>
<p>服务器启动时如果需要读取配置文件，或者结束时需要写入到状态文件时，可以使用同步代码，因为这些代码只在启动和结束时执行一次，不影响服务器正常运行时的异步执行。</p>
<h2 id="js执行环境判断"><a href="#js执行环境判断" class="headerlink" title="js执行环境判断"></a>js执行环境判断</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span>(<span class="built_in">window</span>) === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'node.js'</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'browser'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="基本模块"><a href="#基本模块" class="headerlink" title="基本模块"></a>基本模块</h2><h3 id="fs模块"><a href="#fs模块" class="headerlink" title="fs模块"></a>fs模块</h3><ul>
<li><p>读文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">fs.readFile(<span class="string">'sample.txt'</span>, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>写文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> data = <span class="string">'Hello,Node.js'</span>;</span><br><span class="line">fs.writeFile(<span class="string">'output.txt'</span>, data, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'ok'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取文件信息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">fs.stat(<span class="string">'sample.txt'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, stat</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(txt);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'isFile:'</span> + stat.isFile());</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'isDirectory'</span> + stat.isDirectory());</span><br><span class="line">        <span class="keyword">if</span> (stat.isFile()) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'size:'</span> + stat.size);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'birth time'</span> + stat.birthtime);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'modified time'</span> + stat.mtime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>上述都属异步的方式获取,同步都是加Async,如<code>fs.writeFileSync</code></p>
<ul>
<li><p>读流</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs= <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="comment">//打开一个流</span></span><br><span class="line"><span class="keyword">var</span> rs = fs.createReadStream(<span class="string">'resources/sample.txt'</span>,<span class="string">'utf-8'</span>);</span><br><span class="line"><span class="comment">//开始读取流</span></span><br><span class="line">rs.on(<span class="string">'data'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'DATA:'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(chunk);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//读取结束</span></span><br><span class="line">rs.on(<span class="string">'end'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'end'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//读取有异常</span></span><br><span class="line">rs.on(<span class="string">'error'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'ERROR'</span>+err)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>写流</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ws1=fs.createWriteStream(<span class="string">'resources/output1.txt'</span>,<span class="string">'utf-8'</span>);</span><br><span class="line"></span><br><span class="line">ws1.write(<span class="string">'使用stream写入文本数据...\n'</span>);</span><br><span class="line">ws1.write(<span class="string">'END.'</span>);</span><br><span class="line">ws1.end();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ws2=fs.createWriteStream(<span class="string">'resources/output2.txt'</span>);</span><br><span class="line">ws2.write(<span class="keyword">new</span> Buffer(<span class="string">'使用Stream写入二进制数据...\n'</span>,<span class="string">'utf-8'</span>));</span><br><span class="line">ws2.write(<span class="keyword">new</span> Buffer(<span class="string">'END.'</span>,<span class="string">'utf-8'</span>));</span><br><span class="line">ws2.end();</span><br></pre></td></tr></table></figure>
</li>
<li><p>pipe<br>就像可以把两个水管串成一个更长的水管一样，两个流也可以串起来。一个Readable流和一个Writable流串起来后，所有的数据自动从Readable流进入Writable流，这种操作叫pipe。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rs=fs.createReadStream(<span class="string">'resources/sample.txt'</span>);</span><br><span class="line"><span class="keyword">var</span> ws= fs.createWriteStream(<span class="string">'resources/copied.txt'</span>);</span><br><span class="line">rs.pipe(ws);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="http模块"><a href="#http模块" class="headerlink" title="http模块"></a>http模块</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文件服务器</span></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//解析为当前目录</span></span><br><span class="line"><span class="keyword">var</span> root = path.resolve(process.argv[<span class="number">2</span>] || <span class="string">'.'</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">request, response</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> pathname = url.parse(request.url).pathname;</span><br><span class="line">    <span class="keyword">var</span> filepath = path.join(root, pathname);</span><br><span class="line">    fs.stat(filepath, <span class="function"><span class="keyword">function</span> (<span class="params">err, stats</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!err &amp;&amp; stats.isFile()) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'200'</span> + request.url);</span><br><span class="line">            response.writeHead(<span class="number">200</span>,&#123;<span class="string">"Content-Type"</span>:<span class="string">"application/jaContent-Typevascript; charset=utf-8"</span>&#125;);</span><br><span class="line">            <span class="comment">//将文件流导向response;</span></span><br><span class="line">            fs.createReadStream(filepath, <span class="string">'utf-8'</span>).pipe(response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response.writeHead(<span class="number">404</span>);</span><br><span class="line">            response.end(<span class="string">'404 Not Found'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">8090</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Server is running at http://127.0.0.1:8090/'</span>);</span><br></pre></td></tr></table></figure>
<p>我们访问根目录下的文件时候就会看到文件里面的内容,这里我访问的是js文件,所有设置了content-type如果是html,可自行设置</p>
<h3 id="crypto模块"><a href="#crypto模块" class="headerlink" title="crypto模块"></a>crypto模块</h3><ul>
<li><p>MD5<br>MD5是一种常用的哈希算法，用于给任意数据一个“签名”。这个签名通常用一个十六进制的字符串表示</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">var</span> hash = crypto.createHash(<span class="string">'md5'</span>);</span><br><span class="line">hash.update(<span class="string">'admin'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'MD:'</span>+hash.digest(<span class="string">'hex'</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>sha1</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sha1 = crypto.createHash(<span class="string">'sha1'</span>);</span><br><span class="line">sha1.update(<span class="string">'admin'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'sha1:'</span> + sha1.digest(<span class="string">"hex"</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>Hmac<br>Hmac算法也是一种哈希算法，它可以利用MD5或SHA1等哈希算法。不同的是，Hmac还需要一个密钥：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hmac = crypto.createHmac(<span class="string">'md5'</span>, <span class="string">'secret-key'</span>);</span><br><span class="line">hmac.update(<span class="string">'admin'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Hmac:'</span> + hmac.digest(<span class="string">'hex'</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>AES<br>AES是一种常用的对称加密算法，加解密都用同一个密钥。crypto模块提供了AES支持，但是需要自己封装好函数，便于使用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aesEncrypt</span>(<span class="params">data, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> cipher = crypto.createCipheriv(<span class="string">'aes192'</span>, key, <span class="string">'1111111111111111'</span>);</span><br><span class="line">    <span class="keyword">var</span> cryted = cipher.update(data, <span class="string">'utf8'</span>, <span class="string">'hex'</span>);</span><br><span class="line">    cryted += cipher.final(<span class="string">'hex'</span>);</span><br><span class="line">    <span class="keyword">return</span> cryted;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aesDecrypt</span>(<span class="params">encrypted, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> decipher = crypto.createDecipheriv(<span class="string">'aes192'</span>, key, <span class="string">'1111111111111111'</span>);</span><br><span class="line">    <span class="keyword">var</span> descypted = decipher.update(encrypted, <span class="string">'hex'</span>, <span class="string">'utf8'</span>);</span><br><span class="line">    descypted += decipher.final(<span class="string">'utf8'</span>);</span><br><span class="line">    <span class="keyword">return</span> descypted;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data = <span class="string">'hello,this is a secret message'</span>;</span><br><span class="line"><span class="keyword">var</span> key = <span class="string">'111111111111111111111111'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> encrypted = aesEncrypt(data, key);</span><br><span class="line"><span class="keyword">var</span> decrypted = aesDecrypt(encrypted, key);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Plain text'</span> + data);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'aes Encrypted text'</span> + encrypted);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'aes encrypted text'</span> + decrypted);</span><br></pre></td></tr></table></figure>
</li>
<li><p>diffie-hellman<br>DH算法是一种密钥交换协议，它可以让双方在不泄漏密钥的情况下协商出一个密钥来。搞不懂啥意思,先记下来</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> primeLength = <span class="number">1024</span>; <span class="comment">// 素数p的长度</span></span><br><span class="line"><span class="keyword">var</span> generator = <span class="number">5</span>; <span class="comment">// 素数a</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建客户端的DH实例</span></span><br><span class="line"><span class="keyword">var</span> client = crypto.createDiffieHellman(primeLength, generator);</span><br><span class="line"><span class="comment">// 产生公、私钥对，Ya = a^Xa mod p</span></span><br><span class="line"><span class="keyword">var</span> clientKey = client.generateKeys();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建服务端的DH实例，采用跟客户端相同的素数a、p</span></span><br><span class="line"><span class="keyword">var</span> server = crypto.createDiffieHellman(client.getPrime(), client.getGenerator());</span><br><span class="line"><span class="comment">// 产生公、私钥对，Yb = a^Xb mod p</span></span><br><span class="line"><span class="keyword">var</span> serverKey = server.generateKeys();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算 Ka = Yb^Xa mod p</span></span><br><span class="line"><span class="keyword">var</span> clientSecret = client.computeSecret(server.getPublicKey());</span><br><span class="line"><span class="comment">// 计算 Kb = Ya^Xb mod p</span></span><br><span class="line"><span class="keyword">var</span> serverSecret = server.computeSecret(client.getPublicKey());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 由于素数p是动态生成的，所以每次打印都不一样</span></span><br><span class="line"><span class="comment">// 但是 clientSecret === serverSecret</span></span><br><span class="line"><span class="built_in">console</span>.log(clientSecret.toString(<span class="string">'hex'</span>));</span><br><span class="line"><span class="built_in">console</span>.log(serverSecret.toString(<span class="string">'hex'</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>RSA<br>RSA算法是一种非对称加密算法，即由一个私钥和一个公钥构成的密钥对，通过私钥加密，公钥解密，或者通过公钥加密，私钥解密。其中，公钥可以公开，私钥必须保密。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> crypto=<span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadkey</span>(<span class="params">file</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fs.readFileSync(file,<span class="string">'utf8'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> prvkey = loadkey(<span class="string">'./rsa-prv.pem'</span>);</span><br><span class="line"><span class="keyword">var</span> pubkey = loadkey(<span class="string">'./rsa-pub.pem'</span>);</span><br><span class="line"><span class="keyword">var</span> message=<span class="string">'hello world'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用私钥加密</span></span><br><span class="line"><span class="keyword">var</span> enc_by_prv = crypto.privateEncrypt(prvkey,Buffer.from(message,<span class="string">'utf8'</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'私钥加密 '</span>+enc_by_prv.toString(<span class="string">'hex'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用公钥解密</span></span><br><span class="line"><span class="keyword">var</span> dec_by_pub = crypto.publicDecrypt(pubkey,enc_by_prv);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'公钥解密'</span>+dec_by_pub.toString(<span class="string">'utf8'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用公钥加密</span></span><br><span class="line"><span class="keyword">var</span> enc_by_pub = crypto.publicEncrypt(pubkey,Buffer.from(message,<span class="string">'utf8'</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'公钥加密'</span>+enc_by_pub.toString(<span class="string">'hex'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用私钥解密</span></span><br><span class="line"><span class="keyword">var</span> dec_by_prv = crypto.privateDecrypt(prvkey,enc_by_pub);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'私钥解密'</span>+dec_by_prv.toString(<span class="string">'utf8'</span>));</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Web开发"><a href="#Web开发" class="headerlink" title="Web开发"></a>Web开发</h2><p>由于Node.js把JavaScript引入了服务器端,因此，原来必须使用PHP/Java/C#/Python/Ruby等其他语言来开发服务器端程序，现在可以使用Node.js开发了！<br>在Node.js诞生后的短短几年里，出现了无数种Web框架、ORM框架、模版引擎、测试框架、自动化构建工具，数量之多</p>
<h3 id="koa-Web框架"><a href="#koa-Web框架" class="headerlink" title="koa Web框架"></a>koa Web框架</h3><p>koa是Express的下一代基于Node.js的web框架，目前有1.x和2.0两个版本。</p>
<ul>
<li>历史</li>
</ul>
<ol>
<li>Express<br>Express是第一代最流行的web框架，它对Node.js的http进行了封装，用起来如下：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app=express();</span><br><span class="line">app.get(<span class="string">'/'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">    res.send(<span class="string">'hello world'</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Example app listen on port 3000'</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>虽然Express的API很简单，但是它是基于ES5的语法，要实现异步代码，只有一个方法：回调。如果异步嵌套层次过多，代码写起来就非常难看：</p>
<ol start="2">
<li><p>koa 1.0<br>随着新版Node.js开始支持ES6，Express的团队又基于ES6的generator重新编写了下一代web框架koa。和Express相比，koa 1.0使用generator实现异步，代码看起来像同步的：</p>
</li>
<li><p>koa 2.0<br>koa团队并没有止步于koa 1.0，他们非常超前地基于ES7开发了koa2，和koa 1相比，koa2完全使用Promise并配合async来实现异步。</p>
</li>
</ol>
<p>本教程将使用教程将使用最新的koa2开发！</p>
<h4 id="创建Koa工程"><a href="#创建Koa工程" class="headerlink" title="创建Koa工程"></a>创建Koa工程</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入koa，和koa 1.x不同，在koa2中，我们导入的是一个class，因此用大写的Koa表示:</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个Koa对象表示web app本身:</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对于任何请求，app将调用该异步函数处理请求：</span></span><br><span class="line">app.use(<span class="keyword">async</span>(ctx,next)=&gt;&#123;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    ctx.response.type=<span class="string">'text/html'</span>;</span><br><span class="line">    ctx.response.body=<span class="string">'&lt;h1&gt;hello,koa2&lt;/h1&gt;'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'app started at port 3000...'</span>);</span><br></pre></td></tr></table></figure>
<p>打卡浏览器访问<a href="http://localhost:3000" target="_blank" rel="noopener">http://localhost:3000</a>;</p>
<p><code>koa middleware</code></p>
<p>koa把很多async函数组成一个处理链，每个async函数都可以做一些自己的事情，然后用await next()来调用下一个async函数。我们把每个async函数称为middleware，这些middleware可以组合起来，完成很多有用的功能。</p>
<p>如下面3个middleware组成处理链，依次打印日志，记录处理时间，输出HTML：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">await</span> next(); <span class="comment">//调用下一个middleware</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">    <span class="keyword">await</span> next(); <span class="comment">//调用下一个middleware</span></span><br><span class="line">    <span class="keyword">var</span> ms = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime() - start;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`time:<span class="subst">$&#123;ms&#125;</span>ms`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    ctx.response.type = <span class="string">'text/html'</span>;</span><br><span class="line">    ctx.response.body = <span class="string">'&lt;h1&gt;Hello,koa2&lt;/h1&gt;'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<p>middleware的顺序很重要，也就是调用app.use()的顺序决定了middleware的顺序。</p>
<p>此外，如果一个middleware没有调用await next()，会怎么办？答案是后续的middleware将不再执行了。</p>
<h4 id="处理url"><a href="#处理url" class="headerlink" title="处理url"></a>处理url</h4><p>在hello-koa工程中，我们处理http请求一律返回相同的HTML，这样虽然非常简单，但是用浏览器一测，随便输入任何URL都会返回相同的网页。</p>
<p>正常情况下，我们应该对不同的URL调用不同的处理函数</p>
<p>应该有一个能集中处理URL的middleware，它根据不同的URL调用不同的处理函数，这样，我们才能专心为每个URL编写处理函数。</p>
<ul>
<li>koa-router get请求<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get请求</span></span><br><span class="line"><span class="keyword">var</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="comment">//注意require('koa-router')返回的是函数</span></span><br><span class="line"><span class="keyword">var</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// log request URL;</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Process <span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>...`</span>);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add  url-route</span></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/hello/:name'</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> name = ctx.params.name;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;hello,<span class="subst">$&#123;name&#125;</span>&lt;/h1&gt;`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>,<span class="keyword">async</span>(ctx,next)=&gt;&#123;</span><br><span class="line">    ctx.response.body=<span class="string">`&lt;h1&gt;Index&lt;/h1&gt;`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(router.routes());</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'app started at port 3000'</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>用post请求处理URL时，我们会遇到一个问题：post请求通常会发送一个表单，或者JSON，它作为request的body发送，但无论是Node.js提供的原始request对象，还是koa提供的request对象，都不提供解析request的body的功能！</p>
<p>所以，我们又需要引入另一个middleware来解析原始request请求，然后，把解析后的参数，绑定到ctx.request.body中。</p>
<p>koa-bodyparser就是用来干这个活的。</p>
<ul>
<li>koa-router post请求<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//post请求</span></span><br><span class="line"><span class="keyword">var</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="comment">//注意require('koa-router')返回的是函数</span></span><br><span class="line"><span class="keyword">var</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bodyParser=<span class="built_in">require</span>(<span class="string">'koa-bodyParser'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">// log request URL;</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Process <span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>...`</span>);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>,<span class="keyword">async</span>(ctx,next)=&gt;&#123;</span><br><span class="line">    ctx.response.body=<span class="string">`&lt;h1&gt;Index&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            &lt;form action="/sigin" method='post'&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt;Name:&lt;input name="name" value="koa"/&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt;Password:&lt;input name="password" type="password"/&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt;&lt;input type="submit"value="Submit"/&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;/form&gt;`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/sigin'</span>,<span class="keyword">async</span>(ctx,next)=&gt;&#123;</span><br><span class="line">    <span class="keyword">var</span> name=ctx.request.body.name||<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> password=ctx.request.body.password||<span class="string">''</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`signin with name:<span class="subst">$&#123;name&#125;</span>,password:<span class="subst">$&#123;password&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span>(name === <span class="string">'koa'</span> &amp;&amp; password===<span class="string">'12345'</span>)&#123;</span><br><span class="line">        ctx.response.body=<span class="string">`&lt;h1&gt;welcome:<span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        ctx.response.body=<span class="string">`&lt;h1&gt;Login field&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;&lt;a href='/'&gt;Try again&lt;/a&gt;&lt;/p&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(bodyParser());</span><br><span class="line">app.use(router.routes());</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'app started at port 3000'</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>所有的URL处理函数都放到app.js里显得很乱，而且，每加一个URL，就需要修改app.js。随着URL越来越多，app.js就会越来越长。</p>
<p>如果能把URL处理函数集中到某个js文件，或者某几个js文件中就好了，然后让app.js自动导入所有处理URL的函数。这样，代码一分离，逻辑就显得清楚了。</p>
<ul>
<li>重构<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// url2-koa/</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- controllers/</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- hello.js &lt;-- 处理login相关URL</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- index.js &lt;-- 处理用户管理相关URL</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- app.js &lt;-- 使用koa的js</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- controller.js &lt;-- 自动处理url函数js</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- package.json &lt;-- 项目描述文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- node_modules/ &lt;-- npm安装的所有依赖包</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//hello.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fn_hello = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> name = ctx.params.name;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;Hello, <span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="string">'GET /hello/:name'</span>: fn_hello</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//index.js</span></span><br><span class="line"><span class="keyword">var</span> fn_index = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;Index&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;form action="/signin" method="post"&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Name: &lt;input name="name" value="koa"&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Password: &lt;input name="password" type="password"&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;&lt;input type="submit" value="Submit"&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;`</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fn_signin = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> name = ctx.request.body.name || <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> password = ctx.request.body.password || <span class="string">''</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`signin with name: <span class="subst">$&#123;name&#125;</span>, password: <span class="subst">$&#123;password&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (name === <span class="string">'koa'</span> &amp;&amp; password === <span class="string">'12345'</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">`&lt;h1&gt;Welcome, <span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctx.response.body = <span class="string">`&lt;h1&gt;Login failed!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;&lt;a href="/"&gt;Try again&lt;/a&gt;&lt;/p&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports=&#123;</span><br><span class="line">    <span class="string">'GET /'</span>:fn_index,</span><br><span class="line">    <span class="string">'POST /signin'</span>:fn_signin</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//controller.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 先导入fs模块，然后用readdirSync列出文件</span></span><br><span class="line"><span class="comment">// 这里可以用sync是因为启动时只运行一次，不存在性能问题:</span></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addMapping</span>(<span class="params">router, mapping</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> url <span class="keyword">in</span> mapping) &#123;</span><br><span class="line">        <span class="keyword">if</span> (url.startsWith(<span class="string">'GET '</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">4</span>);</span><br><span class="line">            router.get(path, mapping[url]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`register URL mapping: GET <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.startsWith(<span class="string">'POST '</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">5</span>);</span><br><span class="line">            router.post(path, mapping[url]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`register URL mapping: POST <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`invalid URL: <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addControllers</span>(<span class="params">router</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> files = fs.readdirSync(__dirname + <span class="string">'/controllers'</span>);</span><br><span class="line">    <span class="keyword">var</span> js_files = files.filter(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> f.endsWith(<span class="string">'.js'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> f <span class="keyword">of</span> js_files) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`process controller: <span class="subst">$&#123;f&#125;</span>...`</span>);</span><br><span class="line">        <span class="keyword">let</span> mapping = <span class="built_in">require</span>(__dirname + <span class="string">'/controllers/'</span> + f);</span><br><span class="line">        addMapping(router, mapping);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">dir</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> controllers_dir = dir || <span class="string">'controllers'</span>; <span class="comment">// 如果不传参数，扫描目录默认为'controllers'</span></span><br><span class="line">    <span class="keyword">var</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</span><br><span class="line">    addControllers(router, controllers_dir);</span><br><span class="line">    <span class="keyword">return</span> router.routes();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//app.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Koa=<span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bodyParser=<span class="built_in">require</span>(<span class="string">'koa-bodyParser'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入controller middleware:</span></span><br><span class="line"><span class="keyword">var</span> controller = <span class="built_in">require</span>(<span class="string">'./controller'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(bodyParser());</span><br><span class="line">app.use(controller());</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="使用Nunjucks"><a href="#使用Nunjucks" class="headerlink" title="使用Nunjucks"></a>使用Nunjucks</h4><p>Nunjucks是什么东东？其实它是一个模板引擎。<br>那什么是模板引擎？<br>模板引擎就是基于模板配合数据构造出字符串输出的一个组件。比如下面的函数就是一个模板引擎：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">examResult</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;data.name&#125;</span>同学一年级期末考试语文<span class="subst">$&#123;data.chinese&#125;</span>分，数学<span class="subst">$&#123;data.math&#125;</span>分，位于年级第<span class="subst">$&#123;data.ranking&#125;</span>名。`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们输入数据如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">examResult(&#123;</span><br><span class="line">    name: <span class="string">'小明'</span>,</span><br><span class="line">    chinese: <span class="number">78</span>,</span><br><span class="line">    math: <span class="number">87</span>,</span><br><span class="line">    ranking: <span class="number">999</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>该模板引擎把模板字符串里面对应的变量替换以后，就可以得到以下输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">小明同学一年级期末考试语文78分，数学87分，位于年级第999名。</span><br></pre></td></tr></table></figure></p>
<p>模板引擎最常见的输出就是输出网页，也就是HTML文本。</p>
<p>输出HTML有几个特别重要的问题需要考虑：JavaScript的模板字符串实现起来非常困难</p>
<ul>
<li>转义<br>对特殊字符要转义，避免受到XSS攻击。比如，如果变量name的值不是小明，而是小明<script>…</script>，模板引擎输出的HTML到了浏览器，就会自动执行恶意JavaScript代码。</li>
<li>格式化<br>对不同类型的变量要格式化，比如，货币需要变成12,345.00这样的格式，日期需要变成2016-01-01这样的格式。</li>
<li>简单逻辑<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; name &#125;&#125;同学，</span><br><span class="line">&#123;% if score &gt;= 90 %&#125;</span><br><span class="line">    成绩优秀，应该奖励</span><br><span class="line">&#123;% elif score &gt;=60 %&#125;</span><br><span class="line">    成绩良好，继续努力</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    不及格，建议回家打屁股</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>所以，我们需要一个功能强大的模板引擎，来完成页面输出的功能。</p>
<p>我们选择Nunjucks作为模板引擎。Nunjucks是Mozilla开发的一个纯JavaScript编写的模板引擎，既可以用在Node环境下，又可以运行在浏览器端。但是，主要还是运行在Node环境下，因为浏览器端有更好的模板解决方案，例如MVVM框架。</p>
<p>如果你使用过Python的模板引擎jinja2，那么使用Nunjucks就非常简单，两者的语法几乎是一模一样的，因为Nunjucks就是用JavaScript重新实现了jinjia2。</p>
<ul>
<li><p>基本渲染</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// use-nunjucks/</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- views/</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- hello.html &lt;-- 处理login相关URL</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// +- app.js &lt;-- 使用koa的js</span></span><br><span class="line"><span class="comment">// +- package.json &lt;-- 项目描述文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- node_modules/ &lt;-- npm安装的所有依赖包</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//hello.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;h1&gt;hello &#123;&#123;name&#125;&#125;&lt;/h1&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//简单的渲染 app.js</span></span><br><span class="line"><span class="keyword">var</span> nunjucks = <span class="built_in">require</span>(<span class="string">'nunjucks'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createEnv</span>(<span class="params">path, opts</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> autoescape = opts.autoescape === <span class="literal">undefined</span> ? <span class="literal">true</span> : opts.autoescape;</span><br><span class="line">    <span class="keyword">var</span> noCache = opts.noCache || <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> watch = opts.watch | <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> throwOnUndefined = opts.throwOnUndefined || <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> env = <span class="keyword">new</span> nunjucks.Environment(</span><br><span class="line">        <span class="keyword">new</span> nunjucks.FileSystemLoader(path, &#123;</span><br><span class="line">            noCache: noCache,</span><br><span class="line">            watch: watch</span><br><span class="line">        &#125;), &#123;</span><br><span class="line">            autoescape: autoescape,</span><br><span class="line">            throwOnUndefined: throwOnUndefined</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> env;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> env = createEnv(<span class="string">'views'</span>, &#123;</span><br><span class="line">    watch: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s = env.render(<span class="string">'hello.html'</span>, &#123;</span><br><span class="line">    name: <span class="string">'小明1'</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(s);</span><br></pre></td></tr></table></figure>
</li>
<li><p>继承</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// use-nunjucks/</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- views/</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- base.html</span></span><br><span class="line"><span class="comment">// |  +- extend.html</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- app.js &lt;-- 使用koa的js</span></span><br><span class="line"><span class="comment">// +- package.json &lt;-- 项目描述文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- node_modules/ &lt;-- npm安装的所有依赖包</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//base.html</span></span><br><span class="line"><span class="comment">// &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="comment">// &lt;html lang="en"&gt;</span></span><br><span class="line"><span class="comment">// &lt;head&gt;</span></span><br><span class="line"><span class="comment">//     &lt;meta charset="UTF-8"&gt;</span></span><br><span class="line"><span class="comment">//     &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</span></span><br><span class="line"><span class="comment">//     &lt;meta http-equiv="X-UA-Compatible" content="ie=edge"&gt;</span></span><br><span class="line"><span class="comment">//     &lt;title&gt;Document&lt;/title&gt;</span></span><br><span class="line"><span class="comment">// &lt;/head&gt;</span></span><br><span class="line"><span class="comment">// &lt;body&gt;</span></span><br><span class="line"><span class="comment">//     &#123;% block header %&#125;&lt;h3&gt;Unnamed&lt;/h3&gt;&#123;% endblock  %&#125;</span></span><br><span class="line"><span class="comment">//     &#123;% block body %&#125;&lt;div&gt;No body&lt;/div&gt;&#123;% endblock  %&#125;</span></span><br><span class="line"><span class="comment">//     &#123;% block footer%&#125;&lt;div&gt;copyright&lt;/div&gt;&#123;% endblock  %&#125;    </span></span><br><span class="line"><span class="comment">// &lt;/body&gt;</span></span><br><span class="line"><span class="comment">// &lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//extend.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;% extends 'base.html' %&#125;</span></span><br><span class="line"><span class="comment">// &#123;% block header%&#125;&lt;h1&gt;&#123;&#123;header&#125;&#125;&lt;/h1&gt;&#123;% endblock  %&#125;</span></span><br><span class="line"><span class="comment">// &#123;% block body%&#125;&lt;p&gt;&#123;&#123;body&#125;&#125;&lt;/p&gt;&#123;% endblock %&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//app.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(env.render(<span class="string">'extend.html'</span>,&#123;</span><br><span class="line">    header:<span class="string">'hello'</span>,</span><br><span class="line">    body:<span class="string">'bla la la...'</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
</li>
<li><p>性能<br>对于模板渲染本身来说，速度是非常非常快的，因为就是拼字符串嘛，纯CPU操作。<br>性能问题主要出现在从文件读取模板内容这一步。这是一个IO操作，在Node.js环境中，我们知道，单线程的JavaScript最不能忍受的就是同步IO，但Nunjucks默认就使用同步IO读取模板文件。<br>好消息是Nunjucks会缓存已读取的文件内容，也就是说，模板文件最多读取一次，就会放在内存中，后面的请求是不会再次读取文件的，只要我们指定了noCache: false这个参数。<br>在开发环境下，可以关闭cache，这样每次重新加载模板，便于实时修改模板。在生产环境下，一定要打开cache，这样就不会有性能问题。</p>
</li>
</ul>
<h4 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h4><p>我们已经可以用koa处理不同的URL，还可以用Nunjucks渲染模板。现在，是时候把这两者结合起来了！<br>这就是传说中的MVC：Model-View-Controller，中文名“模型-视图-控制器”。</p>
<ul>
<li>异步函数是C：Controller，Controller负责业务逻辑，比如检查用户名是否存在，取出用户信息等等；</li>
<li>包含变量的模板就是V：View，View负责显示逻辑，通过简单地替换一些变量，View最终输出的就是用户看到的HTML。</li>
<li>Model就是一个JavaScript对象：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">name</span>: <span class="string">'Michael'</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>工程view-koa结构如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">view-koa/</span><br><span class="line">|</span><br><span class="line">+- controllers/ &lt;-- Controller</span><br><span class="line">|</span><br><span class="line">| +- index.js</span><br><span class="line">| +- signin.js</span><br><span class="line">+- views/ &lt;-- html模板文件</span><br><span class="line">|</span><br><span class="line">+- static/ &lt;-- 静态资源文件</span><br><span class="line">|</span><br><span class="line">+- controller.js &lt;-- 扫描注册Controller</span><br><span class="line">|</span><br><span class="line">+- static-files.js</span><br><span class="line">|</span><br><span class="line">+- templating.js</span><br><span class="line">|</span><br><span class="line">+- app.js &lt;-- 使用koa的js</span><br><span class="line">|</span><br><span class="line">+- package.json &lt;-- 项目描述文件</span><br><span class="line">|</span><br><span class="line">+- node_modules/ &lt;-- npm安装的所有依赖包</span><br></pre></td></tr></table></figure></p>
<p>这里只列出主要代码部分,静态资源文件和html文件自己补充即可</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="string">'GET /'</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        ctx.render(<span class="string">'index.html'</span>, &#123;</span><br><span class="line">            title: <span class="string">'welcome'</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//signin.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="string">'POST /signin'</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">var</span> email = ctx.request.body.email || <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">var</span> password = ctx.request.body.password || <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">if</span> (email === <span class="string">'admin@example.com'</span> &amp;&amp; password === <span class="string">'123456'</span>) &#123;</span><br><span class="line">            ctx.render(<span class="string">'signin-ok.html'</span>, &#123;</span><br><span class="line">                title: <span class="string">'Sign In Ok'</span>,</span><br><span class="line">                name: <span class="string">'Mr Node'</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.render(<span class="string">'signin-failed.html'</span>, &#123;</span><br><span class="line">                title: <span class="string">'Sign In Failed'</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//app.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Koa=<span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bodyParser=<span class="built_in">require</span>(<span class="string">'koa-bodyParser'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入controller middleware:</span></span><br><span class="line"><span class="keyword">var</span> controller = <span class="built_in">require</span>(<span class="string">'./controller'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> staticFiles = <span class="built_in">require</span>(<span class="string">'./static-files'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> templating = <span class="built_in">require</span>(<span class="string">'./templating'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isProduction = process.env.NODE_ENV === <span class="string">'production'</span>;</span><br><span class="line">app.use(staticFiles(<span class="string">'/static/'</span>, __dirname + <span class="string">'/static'</span>));</span><br><span class="line">app.use(bodyParser());</span><br><span class="line">app.use(templating(<span class="string">'views'</span>, &#123;</span><br><span class="line">    noCache: !isProduction,</span><br><span class="line">    watch: !isProduction</span><br><span class="line">&#125;));</span><br><span class="line">app.use(controller());</span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//controller.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 先导入fs模块，然后用readdirSync列出文件</span></span><br><span class="line"><span class="comment">// 这里可以用sync是因为启动时只运行一次，不存在性能问题:</span></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addMapping</span>(<span class="params">router, mapping</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> url <span class="keyword">in</span> mapping) &#123;</span><br><span class="line">        <span class="keyword">if</span> (url.startsWith(<span class="string">'GET '</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">4</span>);</span><br><span class="line">            router.get(path, mapping[url]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`register URL mapping: GET <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.startsWith(<span class="string">'POST '</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">5</span>);</span><br><span class="line">            router.post(path, mapping[url]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`register URL mapping: POST <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`invalid URL: <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addControllers</span>(<span class="params">router</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> files = fs.readdirSync(__dirname + <span class="string">'/controllers'</span>);</span><br><span class="line">    <span class="keyword">var</span> js_files = files.filter(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> f.endsWith(<span class="string">'.js'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> f <span class="keyword">of</span> js_files) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`process controller: <span class="subst">$&#123;f&#125;</span>...`</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(__dirname + <span class="string">'/controllers/'</span> + f);</span><br><span class="line">        <span class="keyword">let</span> mapping = <span class="built_in">require</span>(__dirname + <span class="string">'/controllers/'</span> + f);</span><br><span class="line">       </span><br><span class="line">        addMapping(router, mapping);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">dir</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> controllers_dir = dir || <span class="string">'controllers'</span>; <span class="comment">// 如果不传参数，扫描目录默认为'controllers'</span></span><br><span class="line">    <span class="keyword">var</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</span><br><span class="line">    addControllers(router, controllers_dir);</span><br><span class="line">    <span class="keyword">return</span> router.routes();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//static-files.js</span></span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> mime = <span class="built_in">require</span>(<span class="string">'mime'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'mz/fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// url: 类似 '/static/'</span></span><br><span class="line"><span class="comment">// dir: 类似 __dirname + '/static'</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">staticFiles</span>(<span class="params">url, dir</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">var</span> rpath = ctx.request.path;</span><br><span class="line">        <span class="keyword">if</span> (rpath.startsWith(url)) &#123;</span><br><span class="line">            <span class="keyword">var</span> fp = path.join(dir, rpath.substring(url.length));</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> fs.exists(fp)) &#123;</span><br><span class="line">                ctx.response.type = mime.lookup(rpath);</span><br><span class="line">                ctx.response.body = <span class="keyword">await</span> fs.readFile(fp);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ctx.response.status = <span class="number">404</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> next();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = staticFiles;</span><br><span class="line"></span><br><span class="line"><span class="comment">//templating.js</span></span><br><span class="line"><span class="keyword">var</span> nunjucks = <span class="built_in">require</span>(<span class="string">'nunjucks'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createEnv</span>(<span class="params">path, opts</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span></span><br><span class="line">        autoescape = opts.autoescape === <span class="literal">undefined</span> ? <span class="literal">true</span> : opts.autoescape,</span><br><span class="line">        noCache = opts.noCache || <span class="literal">false</span>,</span><br><span class="line">        watch = opts.watch || <span class="literal">false</span>,</span><br><span class="line">        throwOnUndefined = opts.throwOnUndefined || <span class="literal">false</span>,</span><br><span class="line">        env = <span class="keyword">new</span> nunjucks.Environment(</span><br><span class="line">            <span class="keyword">new</span> nunjucks.FileSystemLoader(path || <span class="string">'views'</span>, &#123;</span><br><span class="line">                noCache: noCache,</span><br><span class="line">                watch: watch,</span><br><span class="line">            &#125;), &#123;</span><br><span class="line">                autoescape: autoescape,</span><br><span class="line">                throwOnUndefined: throwOnUndefined</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="keyword">return</span> env;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">templating</span>(<span class="params">path, opts</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> env = createEnv(path, opts);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        ctx.render = <span class="function"><span class="keyword">function</span> (<span class="params">view, model</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 把render后的内容赋值给response.body:</span></span><br><span class="line">            ctx.response.body = env.render(view, <span class="built_in">Object</span>.assign(&#123;&#125;, ctx.state || &#123;&#125;, model || &#123;&#125;));</span><br><span class="line">            <span class="comment">// 设置Content-Type:</span></span><br><span class="line">            ctx.response.type = <span class="string">'text/html'</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 继续处理请求:</span></span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = templating;</span><br></pre></td></tr></table></figure>
<h3 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h3><h4 id="Sequelize"><a href="#Sequelize" class="headerlink" title="Sequelize"></a>Sequelize</h4><p>Node的ORM框架Sequelize,依赖驱动mysql</p>
<ul>
<li><p>配置数据库相关配置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//config.js</span></span><br><span class="line"><span class="keyword">var</span> config = &#123;</span><br><span class="line">    database: <span class="string">'test'</span>, <span class="comment">// 使用哪个数据库</span></span><br><span class="line">    username: <span class="string">'root'</span>, <span class="comment">// 用户名</span></span><br><span class="line">    password: <span class="string">'123'</span>, <span class="comment">// 口令</span></span><br><span class="line">    host: <span class="string">'localhost'</span>, <span class="comment">// 主机名</span></span><br><span class="line">    port: <span class="number">3306</span> <span class="comment">// 端口号，MySQL默认3306</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config;</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化一个实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Sequelize = <span class="built_in">require</span>(<span class="string">'sequelize'</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./config'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sequelize = <span class="keyword">new</span> Sequelize(config.database, config.username, config.password, &#123;</span><br><span class="line">    host: config.host,</span><br><span class="line">    dialect: <span class="string">'mysql'</span>,</span><br><span class="line">    pool: &#123;</span><br><span class="line">        max: <span class="number">5</span>,</span><br><span class="line">        min: <span class="number">0</span>,</span><br><span class="line">        idle: <span class="number">30000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义模型,映射数据库表(此时的数据库应该存在一张表)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Pet = sequelize.define(<span class="string">'pet'</span>, &#123;</span><br><span class="line">    id: &#123;</span><br><span class="line">        type: Sequelize.STRING(<span class="number">50</span>),</span><br><span class="line">        primaryKey: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    name: Sequelize.STRING(<span class="number">100</span>),</span><br><span class="line">    gender: Sequelize.BOOLEAN,</span><br><span class="line">    birth: Sequelize.STRING(<span class="number">10</span>),</span><br><span class="line">    createdAt: Sequelize.BIGINT,</span><br><span class="line">    updatedAt: Sequelize.BIGINT,</span><br><span class="line">    version: Sequelize.BIGINT</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    timestamps: <span class="literal">false</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现增删改查</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// //创建</span></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> dog = <span class="keyword">await</span> Pet.create(&#123;</span><br><span class="line">        id: <span class="string">'d-'</span> + now,</span><br><span class="line">        name: <span class="string">'Odie'</span>,</span><br><span class="line">        gender: <span class="literal">false</span>,</span><br><span class="line">        birth: <span class="string">'2008-08-08'</span>,</span><br><span class="line">        createdAt: now,</span><br><span class="line">        updatedAt: now,</span><br><span class="line">        version: <span class="number">0</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'created: '</span> + <span class="built_in">JSON</span>.stringify(dog));</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="comment">//查询</span></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> pets = <span class="keyword">await</span> Pet.findAll(&#123;</span><br><span class="line">        where: &#123;</span><br><span class="line">            name: <span class="string">'Gaffey'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`find <span class="subst">$&#123;pets.length&#125;</span> pets:`</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> p <span class="keyword">of</span> pets) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(p));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改</span></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> pets = <span class="keyword">await</span> Pet.findAll(&#123;</span><br><span class="line">        where: &#123;</span><br><span class="line">            name: <span class="string">'Gaffey'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    pets.gender=<span class="literal">true</span>;</span><br><span class="line">    pets[<span class="number">0</span>].save();</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除数据</span></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> pets = <span class="keyword">await</span> Pet.findAll(&#123;</span><br><span class="line">        where: &#123;</span><br><span class="line">            name: <span class="string">'Gaffey'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">await</span> pets[<span class="number">0</span>].destroy();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="规范化Model"><a href="#规范化Model" class="headerlink" title="规范化Model"></a>规范化Model</h4><p>一个大型Web App通常都有几十个映射表，一个映射表就是一个Model。如果按照各自喜好，那业务代码就不好写。Model不统一，很多代码也无法复用。<br>所以我们需要一个统一的模型，强迫所有Model都遵守同一个规范，这样不但实现简单，而且容易统一风格。</p>
<ul>
<li>统一主键，名称必须是id，类型必须是STRING(50)；</li>
<li>主键可以自己指定，也可以由框架自动生成（如果为null或undefined）；</li>
<li>所有字段默认为NOT NULL，除非显式指定；</li>
<li>统一timestamp机制，每个Model必须有createdAt、updatedAt和version，分别记录创建时间、修改时间和版本号。其中，createdAt和updatedAt以BIGINT存储时间戳，最大的好处是无需处理时区，排序方便。version每次修改时自增。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// model-sequelize/</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- .vscode/</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- launch.json &lt;-- VSCode 配置文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- models/ &lt;-- 存放所有Model</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- Pet.js &lt;-- Pet</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- User.js &lt;-- User</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- config.js &lt;-- 配置文件入口</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- config-override.js &lt;-- 默认配置文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- config-default.js &lt;-- 默认配置文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- config-test.js &lt;-- 测试配置文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- db.js &lt;-- 如何定义Model</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- model.js &lt;-- 如何导入Model</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- init-db.js &lt;-- 初始化数据库</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- app.js &lt;-- 业务代码</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- package.json &lt;-- 项目描述文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- node_modules/ &lt;-- npm安装的所有依赖包</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//db.js</span></span><br><span class="line"><span class="keyword">var</span> Sequelize = <span class="built_in">require</span>(<span class="string">'sequelize'</span>);</span><br><span class="line"><span class="keyword">var</span> uuid = <span class="built_in">require</span>(<span class="string">'uuid'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">'./config'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`init sequelize...`</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateId</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> uuid.v4();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sequelize = <span class="keyword">new</span> Sequelize(config.database, config.username, config.password, &#123;</span><br><span class="line">    host: config.host,</span><br><span class="line">    dialect: config.dialect,</span><br><span class="line">    pool: &#123;</span><br><span class="line">        max: <span class="number">5</span>,</span><br><span class="line">        min: <span class="number">0</span>,</span><br><span class="line">        idle: <span class="number">10000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> ID_TYPE = Sequelize.STRING(<span class="number">50</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineModel</span>(<span class="params">name, attributes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> attrs = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> attributes) &#123;</span><br><span class="line">        <span class="keyword">var</span> value = attributes[key];</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> (value) == <span class="string">'object'</span> &amp;&amp; value[<span class="string">'type'</span>]) &#123;</span><br><span class="line">            value.allowNull = value.allowNull || <span class="literal">false</span>;</span><br><span class="line">            attrs[key] = value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            attrs[key] = &#123;</span><br><span class="line">                type: value,</span><br><span class="line">                allowNull: <span class="literal">false</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    attrs.id = &#123;</span><br><span class="line">        type: ID_TYPE,</span><br><span class="line">        primaryKey: <span class="literal">true</span></span><br><span class="line">    &#125;;</span><br><span class="line">    attrs.createAt = &#123;</span><br><span class="line">        type: Sequelize.BIGINT,</span><br><span class="line">        allowNull: <span class="literal">false</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    attrs.updateAt = &#123;</span><br><span class="line">        type: Sequelize.BIGINT,</span><br><span class="line">        allowNull: <span class="literal">false</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    attrs.version = &#123;</span><br><span class="line">        type: Sequelize.BIGINT,</span><br><span class="line">        allowNull: <span class="literal">false</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> sequelize.define(name, attrs, &#123;</span><br><span class="line">        tablename: name,</span><br><span class="line">        timestams: <span class="literal">false</span>,</span><br><span class="line">        hooks: &#123;</span><br><span class="line">            beforeValidate: <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> now = <span class="built_in">Date</span>.now();</span><br><span class="line">                <span class="keyword">if</span> (obj.isNewRecord) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">'will create entity...'</span> + obj);</span><br><span class="line">                    <span class="keyword">if</span> (!obj.id) &#123;</span><br><span class="line">                        obj.id = generateId();</span><br><span class="line">                    &#125;;</span><br><span class="line">                    obj.createAt = now;</span><br><span class="line">                    obj.updateAt = now;</span><br><span class="line">                    obj.version = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">'will update entity...'</span> + obj);</span><br><span class="line">                    obj.updateAt = now;</span><br><span class="line">                    obj.version++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> TYPES = [<span class="string">'STRING'</span>, <span class="string">'INTEGER'</span>, <span class="string">'BIGINT'</span>, <span class="string">'TEXT'</span>, <span class="string">'DOUBLE'</span>, <span class="string">'DATEONLY'</span>, <span class="string">'BOOLEAN'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> exp = &#123;</span><br><span class="line">    defineModel: defineModel,</span><br><span class="line">    sync: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">            sequelize.sync(&#123;</span><br><span class="line">                force: <span class="literal">true</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Cannot sync() when NODE_ENV is set to \'production\'.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> type <span class="keyword">of</span> TYPES) &#123;</span><br><span class="line">    exp[type] = Sequelize[type];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exp.ID = ID_TYPE;</span><br><span class="line">exp.generateId = generateId;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = exp;</span><br><span class="line"></span><br><span class="line"><span class="comment">//init-db.js</span></span><br><span class="line"><span class="keyword">var</span> model = <span class="built_in">require</span>(<span class="string">'./model.js'</span>);</span><br><span class="line">model.sync();</span><br><span class="line"><span class="comment">//model.js</span></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> db = <span class="built_in">require</span>(<span class="string">'./db'</span>);</span><br><span class="line"><span class="keyword">var</span> files = fs.readdirSync(__dirname + <span class="string">'/models'</span>);</span><br><span class="line"><span class="keyword">var</span> js_files = files.filter(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> f.endsWith(<span class="string">'.js'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;&#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> f <span class="keyword">of</span> js_files) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`import model from file <span class="subst">$&#123;f&#125;</span>...`</span>);</span><br><span class="line">    <span class="keyword">var</span> name = f.substring(<span class="number">0</span>, f.length - <span class="number">3</span>);</span><br><span class="line">    <span class="built_in">module</span>.exports[name] = <span class="built_in">require</span>(__dirname + <span class="string">'/models/'</span> + f);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports.sync = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    db.sync();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//config.js</span></span><br><span class="line"><span class="keyword">var</span> defaultConfig = <span class="string">'./config-default.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> overrideConfig = <span class="string">'./config-override.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> testConfig = <span class="string">'./config-test.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> config = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'test'</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`load <span class="subst">$&#123;testConfig&#125;</span>...`</span>);</span><br><span class="line">    config = <span class="built_in">require</span>(testConfig);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`load <span class="subst">$&#123;defaultConfig&#125;</span>...`</span>);</span><br><span class="line">    config = <span class="built_in">require</span>(defaultConfig);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fs.statSync(overrideConfig).isFile()) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`load <span class="subst">$&#123;overrideConfig&#125;</span>...`</span>);</span><br><span class="line">            config = <span class="built_in">Object</span>.assign(config, <span class="built_in">require</span>(overrideConfig));</span><br><span class="line">            <span class="built_in">console</span>.log(config);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`Cannot load <span class="subst">$&#123;overrideConfig&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config;</span><br><span class="line"></span><br><span class="line"><span class="comment">//config-default.js</span></span><br><span class="line"><span class="keyword">var</span> config = &#123;</span><br><span class="line">    dialect: <span class="string">'mysql'</span>,</span><br><span class="line">    database: <span class="string">'test'</span>,</span><br><span class="line">    username: <span class="string">'root'</span>,</span><br><span class="line">    password: <span class="string">'123'</span>,</span><br><span class="line">    host: <span class="string">'localhost'</span>,</span><br><span class="line">    port: <span class="number">3306</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config;</span><br><span class="line"><span class="comment">//app.js</span></span><br><span class="line"><span class="keyword">var</span> model = <span class="built_in">require</span>(<span class="string">'./model'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Pet = model.Pet;</span><br><span class="line"><span class="keyword">var</span> User = model.User;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> user = <span class="keyword">await</span> User.create(&#123;</span><br><span class="line">        name: <span class="string">'John'</span>,</span><br><span class="line">        gender: <span class="literal">false</span>,</span><br><span class="line">        email: <span class="string">'john-'</span> + <span class="built_in">Date</span>.now() + <span class="string">'@garfield.pet'</span>,</span><br><span class="line">        passwd: <span class="string">'hahaha'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'created'</span> + <span class="built_in">JSON</span>.stringify(user));</span><br><span class="line">    <span class="keyword">var</span> cat = <span class="keyword">await</span> Pet.create(&#123;</span><br><span class="line">        ownerId: user.id,</span><br><span class="line">        name: <span class="string">'Garfield'</span>,</span><br><span class="line">        gender: <span class="literal">false</span>,</span><br><span class="line">        birth: <span class="string">'2007-07-07'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'created: '</span> + <span class="built_in">JSON</span>.stringify(cat));</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="comment">//Pet.js</span></span><br><span class="line"><span class="keyword">var</span> db = <span class="built_in">require</span>(<span class="string">'../db'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = db.defineModel(<span class="string">'pets'</span>, &#123;</span><br><span class="line">    ownerId: db.ID,</span><br><span class="line">    name: db.STRING(<span class="number">100</span>),</span><br><span class="line">    gender: db.BOOLEAN,</span><br><span class="line">    birth: db.STRING(<span class="number">10</span>),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="mocha"><a href="#mocha" class="headerlink" title="mocha"></a>mocha</h3><p>mocha是JavaScript的一种单元测试框架，既可以在浏览器环境下运行，也可以在Node.js环境下运行。</p>
<ul>
<li>既可以测试简单的JavaScript函数，又可以测试异步代码，因为异步是JavaScript的特性之一；</li>
<li>可以自动运行所有测试，也可以只运行特定的测试；</li>
<li>可以支持before、after、beforeEach和afterEach来编写初始化代码。</li>
</ul>
<p>如果一个模块在运行的时候并不需要，仅仅在开发时才需要，就可以放到devDependencies中。这样，正式打包发布时，devDependencies的包不会被包含进来。</p>
<p>然后使用npm install -D package安装</p>
<h4 id="编写测试"><a href="#编写测试" class="headerlink" title="编写测试"></a>编写测试</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hello-test/</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- .vscode/</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- launch.json &lt;-- VSCode 配置文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- hello.js &lt;-- 待测试js文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- test/ &lt;-- 存放所有test</span></span><br><span class="line"><span class="comment">// ｜ ｜</span></span><br><span class="line"><span class="comment">// |  +- hello-test.js &lt;-- 测试文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- package.json &lt;-- 项目描述文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- node_modules/ &lt;-- npm安装的所有依赖包</span></span><br><span class="line"><span class="comment">//hello.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">...rest</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> n <span class="keyword">of</span> rest) &#123;</span><br><span class="line">        sum += n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//hello-test.js</span></span><br><span class="line"><span class="keyword">var</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sum = <span class="built_in">require</span>(<span class="string">'../hello'</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"#helo.js"</span>, () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    before(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'before'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    after(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'after'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    beforeEach(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'beforeEach'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    afterEach(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'afterEach'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    it(<span class="string">'sum() shoud return 0'</span>, () =&gt; &#123;</span><br><span class="line">        assert.strictEqual(sum(), <span class="number">0</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    it(<span class="string">'sum(1) should return 1'</span>, () =&gt; &#123;</span><br><span class="line">        assert.strictEqual(sum(<span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'sum(1, 2) should return 3'</span>, () =&gt; &#123;</span><br><span class="line">        assert.strictEqual(sum(<span class="number">1</span>, <span class="number">2</span>), <span class="number">3</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'sum(1, 2, 3) should return 6'</span>, () =&gt; &#123;</span><br><span class="line">        assert.strictEqual(sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), <span class="number">6</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>mocha默认执行test目录下的所有测试,不要去改变默认目录</p>
<h4 id="异步测试"><a href="#异步测试" class="headerlink" title="异步测试"></a>异步测试</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async-test/</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- .vscode/</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- launch.json &lt;-- VSCode 配置文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- hello.js &lt;-- 待测试js文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- data.txt &lt;-- 待测试js文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- test/ &lt;-- 存放所有test</span></span><br><span class="line"><span class="comment">// ｜ ｜</span></span><br><span class="line"><span class="comment">// |  +- await-test.js &lt;-- 测试文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- package.json &lt;-- 项目描述文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- node_modules/ &lt;-- npm安装的所有依赖包</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//hello.js</span></span><br><span class="line"><span class="keyword">var</span> fs= <span class="built_in">require</span>(<span class="string">'mz/fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports=<span class="keyword">async</span>()=&gt;&#123;</span><br><span class="line">    <span class="keyword">var</span> expression=<span class="keyword">await</span> fs.readFile(<span class="string">'./data.txt'</span>,<span class="string">'utf-8'</span>);</span><br><span class="line">    <span class="keyword">var</span> fn = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'return '</span>+expression);</span><br><span class="line">    <span class="keyword">var</span> r = fn();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Calculate:<span class="subst">$&#123;expression&#125;</span>=<span class="subst">$&#123;r&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//data.txt</span></span><br><span class="line"><span class="comment">//1 + (2 + 4) * (9 - 2) / 3</span></span><br><span class="line"><span class="comment">//await-test.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> assert=<span class="built_in">require</span>(<span class="string">'assert'</span>);</span><br><span class="line"><span class="keyword">var</span> hello=<span class="built_in">require</span>(<span class="string">'../hello'</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'#async hello'</span>,()=&gt;&#123;</span><br><span class="line">    describe(<span class="string">'#asyncCalculate'</span>,()=&gt;&#123;</span><br><span class="line">        it(<span class="string">"#async with done"</span>,(done)=&gt;&#123;</span><br><span class="line">            (<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> r = <span class="keyword">await</span> hello();</span><br><span class="line">                    assert.strictEqual(r,<span class="number">15</span>);</span><br><span class="line">                    done();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(err)&#123;</span><br><span class="line">                    done(err);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)();</span><br><span class="line">        &#125;);</span><br><span class="line">        it(<span class="string">'#async function'</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> r = <span class="keyword">await</span> hello();</span><br><span class="line">            assert.strictEqual(r, <span class="number">15</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        it(<span class="string">'#sync function'</span>, () =&gt; &#123;</span><br><span class="line">            assert(<span class="literal">true</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="Http测试"><a href="#Http测试" class="headerlink" title="Http测试"></a>Http测试</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// koa-test/</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- .vscode/</span></span><br><span class="line"><span class="comment">// |  |</span></span><br><span class="line"><span class="comment">// |  +- launch.json &lt;-- VSCode 配置文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- app.js &lt;-- 待测试js文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- start.js &lt;-- 待测试js文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- test/ &lt;-- 存放所有test</span></span><br><span class="line"><span class="comment">// ｜ ｜</span></span><br><span class="line"><span class="comment">// |  +- app-test.js &lt;-- 测试文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- package.json &lt;-- 项目描述文件</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// +- node_modules/ &lt;-- npm安装的所有依赖包</span></span><br><span class="line"><span class="comment">//app.js</span></span><br><span class="line"><span class="keyword">var</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> ms = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime() - start;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>:<span class="subst">$&#123;ms&#125;</span>ms`</span>);</span><br><span class="line">    ctx.response.set(<span class="string">'X-Response-Time'</span>, <span class="string">`<span class="subst">$&#123;ms&#125;</span>ms`</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> name = ctx.request.query.name || <span class="string">'world'</span>;</span><br><span class="line">    ctx.response.type = <span class="string">'text/html'</span>;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;hello,<span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports=app;</span><br><span class="line"><span class="comment">//app-test.js</span></span><br><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'supertest'</span>);</span><br><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'../app'</span>);</span><br><span class="line">describe(<span class="string">'#test koa app'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> server = app.listen(<span class="number">9900</span>);</span><br><span class="line">    describe(<span class="string">'#test server'</span>, () =&gt; &#123;</span><br><span class="line">        it(<span class="string">'#test GET /'</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">            <span class="keyword">var</span> res = <span class="keyword">await</span> request(server)</span><br><span class="line">                .get(<span class="string">'/'</span>)</span><br><span class="line">                .expect(<span class="string">'Content-Type'</span>, /text\/html/)</span><br><span class="line">                .expect(<span class="number">200</span>, <span class="string">'&lt;h1&gt;hello,world!&lt;/h1&gt;'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        it(<span class="string">"#test GET /path?name=Bob"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">            <span class="keyword">var</span> res = <span class="keyword">await</span> request(server)</span><br><span class="line">                .get(<span class="string">'/path?name=Bob'</span>)</span><br><span class="line">                .expect(<span class="string">'Content-Type'</span>, /text\/html/)</span><br><span class="line">                .expect(<span class="number">200</span>, <span class="string">'&lt;h1&gt;hello,Bob!&lt;/h1&gt;'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h4><ul>
<li>在当前目录下,执行命令<code>node_modules\mocha\bin\mocha</code></li>
<li>package.json中修改如下<code>&quot;scripts&quot;: {&quot;test&quot;: &quot;mocha&quot;},</code>,在当前目录下执行<code>npm test</code></li>
<li>launch.json中配置<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"version"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">    <span class="string">"configurations"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"Run"</span>,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="string">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">            <span class="string">"program"</span>: <span class="string">"$&#123;workspaceRoot&#125;/hello.js"</span>,</span><br><span class="line">            <span class="string">"stopOnEntry"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"args"</span>: [],</span><br><span class="line">            <span class="string">"cwd"</span>: <span class="string">"$&#123;workspaceRoot&#125;"</span>,</span><br><span class="line">            <span class="string">"preLaunchTask"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="string">"runtimeExecutable"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="string">"runtimeArgs"</span>: [</span><br><span class="line">                <span class="string">"--nolazy"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">"env"</span>: &#123;</span><br><span class="line">                <span class="string">"NODE_ENV"</span>: <span class="string">"development"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"externalConsole"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"sourceMaps"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"outDir"</span>: <span class="literal">null</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"Test"</span>,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="string">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">            <span class="string">"program"</span>: <span class="string">"$&#123;workspaceRoot&#125;/node_modules/mocha/bin/mocha"</span>,</span><br><span class="line">            <span class="string">"stopOnEntry"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"args"</span>: [],</span><br><span class="line">            <span class="string">"cwd"</span>: <span class="string">"$&#123;workspaceRoot&#125;"</span>,</span><br><span class="line">            <span class="string">"preLaunchTask"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="string">"runtimeExecutable"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="string">"runtimeArgs"</span>: [</span><br><span class="line">                <span class="string">"--nolazy"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">"env"</span>: &#123;</span><br><span class="line">                <span class="string">"NODE_ENV"</span>: <span class="string">"test"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"externalConsole"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"sourceMaps"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"outDir"</span>: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>注意第一个配置选项<code>Run</code>是正常执行一个.js文件，第二个配置选项<code>Test</code>我们填入<code>&quot;program&quot;: &quot;${workspaceRoot}/node_modules/mocha/bin/mocha&quot;，</code>并设置<code>env为&quot;NODE_ENV&quot;: &quot;test&quot;</code>，这样，就可以在VS Code中打开Debug面板，选择Test，运行，即可在Console面板中看到测试结果：</p>
<h3 id="webSocket"><a href="#webSocket" class="headerlink" title="webSocket"></a>webSocket</h3><p>WebSocket是HTML5新增的协议,WebSocket并不是全新的协议，而是利用了HTTP协议来建立连接,让浏览器和服务器之间可以建立无限制的全双工通信，任何一方都可以主动发消息给对方<br>首先，WebSocket连接必须由浏览器发起，因为请求协议是一个标准的HTTP请求，格式如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET ws://localhost:3000/ws/chat HTTP/1.1</span><br><span class="line">Host: localhost</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Origin: http://localhost:3000</span><br><span class="line">Sec-WebSocket-Key: client-random-string</span><br><span class="line">Sec-WebSocket-Version: 13</span><br></pre></td></tr></table></figure></p>
<p>该请求和普通的HTTP请求有几点不同：</p>
<ul>
<li>GET请求的地址不是类似/path/，而是以ws://开头的地址</li>
<li>请求头Upgrade: websocket和Connection: Upgrade表示这个连接将要被转换为WebSocket连接；</li>
<li>Sec-WebSocket-Key是用于标识这个连接，并非用于加密数据；</li>
<li>Sec-WebSocket-Version指定了WebSocket的协议版本。<br>随后，服务器如果接受该请求，就会返回如下响应：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 101 Switching Protocols</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Accept: server-random-string</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>该响应代码101表示本次连接的HTTP协议即将被更改，更改后的协议就是Upgrade: websocket指定的WebSocket协议</p>
<p>在Node.js中，使用最广泛的WebSocket模块是ws</p>
<h4 id="ws模块"><a href="#ws模块" class="headerlink" title="ws模块"></a>ws模块</h4><ul>
<li><p>开启服务端</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 导入WebSocket模块:</span></span><br><span class="line"><span class="keyword">var</span> WebSocket= <span class="built_in">require</span>(<span class="string">'ws'</span>);</span><br><span class="line"><span class="comment">// 引用Server类:</span></span><br><span class="line"><span class="keyword">var</span> WebSocketServer = WebSocket.Server;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例化</span></span><br><span class="line"><span class="keyword">var</span> wss=<span class="keyword">new</span> WebSocketServer(&#123;</span><br><span class="line">    port:<span class="number">3000</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">wss.on(<span class="string">'connection'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">ws</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[SERVER] connection()`</span>);</span><br><span class="line">    ws.on(<span class="string">"message"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">message</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`[SERVER] Received:<span class="subst">$&#123;message&#125;</span>`</span>);</span><br><span class="line">        ws.send(<span class="string">`ECHO:<span class="subst">$&#123;message&#125;</span>`</span>,(err)=&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(err)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`[SERVER] error:<span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端连接</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入WebSocket模块:</span></span><br><span class="line"><span class="keyword">var</span> WebSocket= <span class="built_in">require</span>(<span class="string">'ws'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">"ws://localhost:3000"</span>);</span><br><span class="line">ws.on(<span class="string">'open'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[CLIENT] open()`</span>);</span><br><span class="line">    ws.send(<span class="string">'Hello!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 响应收到的消息:</span></span><br><span class="line">ws.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[CLIENT] Received: <span class="subst">$&#123;message&#125;</span>`</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="mvc中集成websocket"><a href="#mvc中集成websocket" class="headerlink" title="mvc中集成websocket"></a>mvc中集成websocket</h4><h3 id="REST"><a href="#REST" class="headerlink" title="REST"></a>REST</h3><p>REST就是一种设计API的模式。最常用的数据格式是JSON。把网页视为一种客户端，是REST架构可扩展的一个关键。</p>
<p>编写REST API，实际上就是编写处理HTTP请求的async函数，不过，REST请求和普通的HTTP请求有几个特殊的地方：</p>
<ul>
<li>REST请求仍然是标准的HTTP请求，但是，除了GET请求外，POST、PUT等请求的body是JSON数据格式，请求的Content-Type为application/json；</li>
<li>REST响应返回的结果是JSON数据格式，因此，响应的Content-Type也是application/json。</li>
</ul>
<p>REST API规范</p>
<ul>
<li>例如，商品Product就是一种资源。获取所有Product的URL如下：<code>GET /api/products</code></li>
<li>而获取某个指定的Product，例如，id为123的Product，其URL如下：<code>GET /api/products/123</code></li>
<li>新建一个Product使用POST请求，JSON数据包含在body中，URL如下：<code>POST /api/products</code></li>
<li>更新一个Product使用PUT请求，例如，更新id为123的Product，其URL如下：<code>PUT /api/products/123</code></li>
<li>删除一个Product使用DELETE请求，例如，删除id为123的Product，其URL如下：<code>DELETE /api/products/123</code></li>
<li>当我们只需要获取部分数据时，可通过参数限制返回的结果集，例如，返回第2页评论，每页10项，按时间排序：<code>GET /api/products/123/reviews?page=2&amp;size=10&amp;sort=time</code></li>
</ul>
<h4 id="koa处理REST"><a href="#koa处理REST" class="headerlink" title="koa处理REST"></a>koa处理REST</h4><h2 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h2><p>本质上，webpack 是一个现代 JavaScript 应用程序的静态模块打包器(module bundler)。当 webpack 处理应用程序时，它会递归地构建一个依赖关系图(dependency graph)，其中包含应用程序需要的每个模块，然后将所有这些模块打包成一个或多个 bundle.</p>
<p>前端自动化构建工具,构建工具就是将源代码转换成可以执行的js、css、html代码.如:</p>
<ul>
<li><p>less 解析less成css</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lessc demo.less //直接在命令窗口看构建的css</span><br><span class="line">lessc demo.less &gt; demo.css //构建css文件并输出到demo.css</span><br></pre></td></tr></table></figure>
</li>
<li><p>uplify-js 压缩js文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uglifyjs demo.js -o demo.min.js</span><br></pre></td></tr></table></figure>
</li>
<li><p>browserify commonjs规范的模块化,浏览器并不兼容,通过browserify可以构建浏览器支持的js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browserify main.js -o bundle.js</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>构建工具主要包括以下几个方面</p>
<ul>
<li>代码转化,如将typescript编译成javascript、将scss编译成css等.</li>
<li>文件优化,压缩js、css、html代码,压缩合并图片等.</li>
<li>代码分割,提取多个页面的公共代码,提取首屏不需要执行部分代码让其异步加载</li>
<li>模块合并,在采用模块化的项目中会有很多个模块和文件,需要通过构建工具将其合并成一个文件</li>
<li>自动刷新,监听本地源代码,自动构建、刷新浏览器</li>
<li>代码校验,在代码提交到仓库前校验代码是否符合规范,以及单元测试是否通过</li>
<li>自动发布,更新代码后,自动构建上线代码发布并传输给发布系统</li>
</ul>
<p>常用的自动构建工具</p>
<ul>
<li>基于任务的,Grunt、Gulp</li>
<li>基于模块的,Browserify、Webpack、rollup.js</li>
<li>整合型工具,Yeoman、FIS、jdf、Athena</li>
</ul>
<p>webpack从4版本开始支持零配置打包,默认会找当前目录下src/index.js文件.默认只能处理js文件,处理其他文件需要加载不同的loader.webpack默认支持commonjs和es6.</p>
<ul>
<li>默认配置,在一个有<code>src/index.js</code>目录下执行<code>webpack</code>会自动生成<code>dist/main.js</code></li>
<li>个性配置,在一个有<code>demo.js</code>目录下执行<code>webpack demo.js -o bundle.js</code>会自动生成<code>bundle.js</code></li>
<li><code>npm init</code>初始化一个项目,会生成一个package.json配置文件,会记录当前项目依赖项.</li>
<li><code>npm install package -D</code>本项目下安装,开发环境需要,生产环境不需要</li>
<li><code>npm install package</code>本项目下安装,开发和生成环境都需要</li>
<li><code>npm install package -g</code>全局安装</li>
</ul>
<h3 id="webpack核心概念"><a href="#webpack核心概念" class="headerlink" title="webpack核心概念"></a>webpack核心概念</h3><ul>
<li><p>入口 指示 webpack 应该使用哪个模块，来作为构建其内部依赖图的开始</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">单入口</span><br><span class="line"><span class="built_in">module</span>.exports=&#123;</span><br><span class="line">    entry:<span class="string">'./src/index.js'</span>,<span class="comment">//入口</span></span><br><span class="line">    output:&#123;</span><br><span class="line">        path:path.resolve(__dirname,<span class="string">'dist'</span>),<span class="comment">//输出目录</span></span><br><span class="line">        filename:<span class="string">'my-first-webpack.bundle.js'</span>,<span class="comment">//输出文件名</span></span><br><span class="line">    &#125;,<span class="comment">//输出</span></span><br><span class="line">    mode:<span class="string">'development'</span>,<span class="comment">//模式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出 告诉 webpack 在哪里输出它所创建的 bundles，以及如何命名这些文件，默认值为 ./dist</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">多入口 多输出</span><br><span class="line"><span class="built_in">module</span>.exports=&#123;</span><br><span class="line">    entry:&#123;</span><br><span class="line">        index:<span class="string">'./src/index.js'</span>,</span><br><span class="line">        app:<span class="string">'./src/app.js'</span></span><br><span class="line">    &#125;,<span class="comment">//入口</span></span><br><span class="line">    output:&#123;</span><br><span class="line">        path:path.resolve(__dirname,<span class="string">'dist'</span>),<span class="comment">//输出目录</span></span><br><span class="line">        filename:<span class="string">'[name].bundle.js'</span>,<span class="comment">//输出文件名</span></span><br><span class="line">    &#125;,<span class="comment">//输出</span></span><br><span class="line">    mode:<span class="string">'development'</span>,<span class="comment">//模式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>loader loader 让 webpack 能够去处理那些非 JavaScript 文件（webpack 自身只理解 JavaScript）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">loader</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: &#123;</span><br><span class="line">        index: <span class="string">'./src/index.js'</span>,</span><br><span class="line">        app: <span class="string">'./src/app.js'</span></span><br><span class="line">    &#125;, <span class="comment">//入口</span></span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">'dist'</span>), <span class="comment">//输出目录</span></span><br><span class="line">        filename: <span class="string">'[name].bundle.js'</span>, <span class="comment">//输出文件名</span></span><br><span class="line">    &#125;, <span class="comment">//输出</span></span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        <span class="comment">//需要在入口文件中引入less文件才可以解析</span></span><br><span class="line">        rules: [&#123;</span><br><span class="line">            test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">            use: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>, <span class="string">'less-loader'</span>]<span class="comment">//从后往前解析</span></span><br><span class="line">        &#125;] </span><br><span class="line">    &#125;,</span><br><span class="line">    mode: <span class="string">'development'</span>, <span class="comment">//模式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>插件 loader 被用于转换某些类型的模块，而插件则可以用于执行范围更广的任务</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">'html-webpack-plugin'</span>);</span><br><span class="line"><span class="comment">//插件</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: &#123;</span><br><span class="line">        index: <span class="string">'./src/index.js'</span>,</span><br><span class="line">        app: <span class="string">'./src/app.js'</span></span><br><span class="line">    &#125;, <span class="comment">//入口</span></span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">'dist'</span>), <span class="comment">//输出目录</span></span><br><span class="line">        filename: <span class="string">'[name].bundle.js'</span>, <span class="comment">//输出文件名</span></span><br><span class="line">    &#125;, <span class="comment">//输出</span></span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        <span class="comment">//需要在入口文件中引入less文件才可以解析</span></span><br><span class="line">        rules: [&#123;</span><br><span class="line">            test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">            use: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>, <span class="string">'less-loader'</span>]<span class="comment">//从后往前解析</span></span><br><span class="line">        &#125;] </span><br><span class="line">    &#125;,</span><br><span class="line">    plugins:[</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin()</span><br><span class="line">    ],</span><br><span class="line">    mode: <span class="string">'development'</span>, <span class="comment">//模式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="常用插件及loader"><a href="#常用插件及loader" class="headerlink" title="常用插件及loader"></a>常用插件及loader</h3><ul>
<li>webpack-deep-scope-plugin<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> webpackDeepScopeAnalysisPlugin = <span class="built_in">require</span>(<span class="string">'webpack-deep-scope-plugin'</span>).default;</span><br><span class="line"><span class="built_in">module</span>.exports=&#123;</span><br><span class="line">    plugins:[</span><br><span class="line">        <span class="keyword">new</span> webpackDeepScopeAnalysisPlugin(),</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>webpack构建生产环境对js的压缩、抖动(过滤一些无用代码),但是对于作用域级别的引用,无法做到很好的抖动.该插件可以弥补这一点,更好的实现抖动</p>
<ul>
<li>mini-css-extract-plugin<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MiniCssExtractPlugin = <span class="built_in">require</span>(<span class="string">'mini-css-extract-plugin'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports=&#123;</span><br><span class="line">    <span class="built_in">module</span>:&#123;</span><br><span class="line">        rules:[</span><br><span class="line">            &#123;</span><br><span class="line">                test:<span class="regexp">/\.css$/</span>,</span><br><span class="line">                use:[MiniCssExtractPlugin.loader,<span class="string">'css-loader'</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins:[</span><br><span class="line">        <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">            <span class="comment">// Options similar to the same options in webpackOptions.output</span></span><br><span class="line">            <span class="comment">// all options are optional</span></span><br><span class="line">            filename: <span class="string">'[name].css'</span>,</span><br><span class="line">            <span class="comment">//chunkFilename: '[id].css',</span></span><br><span class="line">            ignoreOrder: <span class="literal">false</span>, <span class="comment">// Enable to remove warnings about conflicting order</span></span><br><span class="line">          &#125;),</span><br><span class="line">    ],</span><br><span class="line">    mode:<span class="string">'production'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>此插件将 CSS 提取到单独的文件中,</p>
<ul>
<li>purifycss-webpack<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> glob = <span class="built_in">require</span>(<span class="string">'glob-all'</span>)</span><br><span class="line"><span class="keyword">const</span> PurifyCSSPlugin = <span class="built_in">require</span>(<span class="string">'purifycss-webpack'</span>);</span><br><span class="line"><span class="keyword">const</span> MiniCssExtractPlugin = <span class="built_in">require</span>(<span class="string">'mini-css-extract-plugin'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports=&#123;</span><br><span class="line">    <span class="built_in">module</span>:&#123;</span><br><span class="line">        rules:[</span><br><span class="line">            &#123;</span><br><span class="line">                test:<span class="regexp">/\.css$/</span>,</span><br><span class="line">                use:[MiniCssExtractPlugin.loader,<span class="string">'css-loader'</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins:[</span><br><span class="line">        <span class="keyword">new</span> webpackDeepScopeAnalysisPlugin(),</span><br><span class="line">        <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">            <span class="comment">// Options similar to the same options in webpackOptions.output</span></span><br><span class="line">            <span class="comment">// all options are optional</span></span><br><span class="line">            filename: <span class="string">'[name].css'</span>,</span><br><span class="line">            <span class="comment">//chunkFilename: '[id].css',</span></span><br><span class="line">            ignoreOrder: <span class="literal">false</span>, <span class="comment">// Enable to remove warnings about conflicting order</span></span><br><span class="line">          &#125;),</span><br><span class="line">        <span class="keyword">new</span> PurifyCSSPlugin(&#123;</span><br><span class="line">            <span class="comment">// Give paths to parse for rules. These should be absolute!</span></span><br><span class="line">            <span class="comment">// paths: glob.sync(path.join(__dirname, './*.html'),</span></span><br><span class="line">            paths: glob.sync(</span><br><span class="line">                [</span><br><span class="line">                    path.join(__dirname, <span class="string">'./*.html'</span>),</span><br><span class="line">                    path.join(__dirname,<span class="string">'./src/*.js'</span>)</span><br><span class="line">                ])</span><br><span class="line">          &#125;)</span><br><span class="line">      </span><br><span class="line">    ],</span><br><span class="line">    mode:<span class="string">'production'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>此插件使用PurifyCSS从CSS中删除未使用的选择器</p>
<h3 id="出入口、loader、插件"><a href="#出入口、loader、插件" class="headerlink" title="出入口、loader、插件"></a>出入口、loader、插件</h3><ol>
<li>默认</li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 默认入口找当前目录下的src文件夹index.js进行打包 */</span></span><br><span class="line"><span class="selector-tag">webpack</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 默认出口当前目录下的dist文件夹main.js*/</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>指定打包文件</li>
</ol>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webpack demo.js -o bundle.js</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>webpack.config.js</li>
</ol>
<p>遵循common.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> HtmlWebpackPlugin=<span class="built_in">require</span>(<span class="string">'html-webpack-plugin'</span>);</span><br><span class="line"><span class="comment">//插件</span></span><br><span class="line"><span class="keyword">var</span> path=<span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports=&#123;</span><br><span class="line">    <span class="comment">// entry:'./src/index.js',</span></span><br><span class="line">    <span class="comment">//入口</span></span><br><span class="line">    <span class="comment">// output:&#123;</span></span><br><span class="line">    <span class="comment">//     path:path.resolve(__dirname,'dist')</span></span><br><span class="line">    <span class="comment">//     filename:'my-first-webpack.bundle.js'</span></span><br><span class="line">    <span class="comment">// &#125;,</span></span><br><span class="line">    <span class="comment">//出口</span></span><br><span class="line">    entry:&#123;</span><br><span class="line">        index:<span class="string">'./src/index.js'</span>,</span><br><span class="line">        app:<span class="string">'./src/app.js'</span></span><br><span class="line">    &#125;,</span><br><span class="line">     output:&#123;</span><br><span class="line">        path:path.r esolve(__dirname,<span class="string">'dist'</span>)</span><br><span class="line">        filename:<span class="string">'[name].bundle.js'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    mode:<span class="string">'devlopment'</span></span><br><span class="line">    <span class="comment">//模式</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">module</span>:&#123;</span><br><span class="line">        rules:[</span><br><span class="line">            &#123; <span class="attr">test</span>:<span class="regexp">/\.less$/</span>,<span class="attr">use</span>:[<span class="string">'style-loader'</span>,<span class="string">'css-loader'</span>,<span class="string">'less-loader'</span>] &#125;</span><br><span class="line">            <span class="comment">//从后往前解析less-loader-&gt;css-loader-&gt;style-loader</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//loader被用于转某些类型的模块</span></span><br><span class="line"></span><br><span class="line">    plugins:[</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin(&#123;<span class="attr">template</span>:<span class="string">'./src/index.html'</span>&#125;)</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment">//插件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="js-tree-shaking"><a href="#js-tree-shaking" class="headerlink" title="js tree shaking"></a>js tree shaking</h3><p>打包的时候删除一些无用的代码,webpack本身对作用域的代码无法检测,需要借助插件(webpack-deep-scope-plugin)来更好的shaking</p>
<h3 id="css-tree-shaking"><a href="#css-tree-shaking" class="headerlink" title="css tree shaking"></a>css tree shaking</h3><p>webpack自身不支持抖动css</p>
<p>打包的时候删除一些没有引用的样式代码</p>
<p>mini-css-extract-plugi 单独抽离css文件</p>
<p>purfycss-webpack 打包抖掉无用的css文件</p>
<p>css抖动放在js前</p>
<p>注释会被匹配掉,不会抖掉</p>
<h3 id="postcss"><a href="#postcss" class="headerlink" title="postcss"></a>postcss</h3><ol>
<li>把css解析成js,解析成语法树</li>
<li>调用插件操作语法树(autoprefixer(加前缀)、cssnano(压缩)、)</li>
</ol>
<h3 id="htmlwebpackplugin"><a href="#htmlwebpackplugin" class="headerlink" title="htmlwebpackplugin"></a>htmlwebpackplugin</h3><p>自动生成html文件并引入css、js文件</p>
<h3 id="提取公共js代码"><a href="#提取公共js代码" class="headerlink" title="提取公共js代码"></a>提取公共js代码</h3><h3 id="图片处理"><a href="#图片处理" class="headerlink" title="图片处理"></a>图片处理</h3><p>url-loader 处理关于图片打包</p>
<h3 id="开启本地服务器"><a href="#开启本地服务器" class="headerlink" title="开启本地服务器"></a>开启本地服务器</h3><p>web-dev-server</p>
<p>webpack -w  不开启服务监听本地文件变化</p>
<h3 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h3><p>HotModuleReplacementPlugin();插件</p>
<h2 id="gulp"><a href="#gulp" class="headerlink" title="gulp"></a>gulp</h2><p>gulp强调的是前端开发的工作流程，我们可以通过配置一系列的task，定义task处理的事务（例如文件压缩合并、雪碧图、启动server、版本控制等），然后定义执行顺序，来让gulp执行这些task，从而构建项目的整个前端开发流程。</p>
<p>简单说就一个Task Runner</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> &#123;</span><br><span class="line">    watch,</span><br><span class="line">    series,</span><br><span class="line">    task,</span><br><span class="line">    dest,</span><br><span class="line">    src</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//压缩html插件</span></span><br><span class="line"><span class="keyword">var</span> htmlclean = <span class="built_in">require</span>(<span class="string">'gulp-htmlclean'</span>);</span><br><span class="line"><span class="comment">//压缩图片狗比玩意里面的默认插件,非常容易安装失败,多安装即便,再默认源和淘宝源之间尝试切换</span></span><br><span class="line"><span class="keyword">var</span> imageMin = <span class="built_in">require</span>(<span class="string">'gulp-imagemin'</span>);</span><br><span class="line"><span class="comment">//压缩js</span></span><br><span class="line"><span class="keyword">var</span> uglify = <span class="built_in">require</span>(<span class="string">'gulp-uglify'</span>);</span><br><span class="line"><span class="comment">//去掉js中的调试语句</span></span><br><span class="line"><span class="keyword">const</span> stripDebug = <span class="built_in">require</span>(<span class="string">'gulp-strip-debug'</span>);</span><br><span class="line"><span class="comment">//将less转换成css</span></span><br><span class="line"><span class="keyword">var</span> less = <span class="built_in">require</span>(<span class="string">'gulp-less'</span>);</span><br><span class="line"><span class="comment">//css压缩</span></span><br><span class="line"><span class="keyword">let</span> cleanCSS = <span class="built_in">require</span>(<span class="string">'gulp-clean-css'</span>);</span><br><span class="line"><span class="comment">//css添加前缀</span></span><br><span class="line"><span class="keyword">var</span> postcss = <span class="built_in">require</span>(<span class="string">'gulp-postcss'</span>);</span><br><span class="line"><span class="keyword">var</span> autoprefixer = <span class="built_in">require</span>(<span class="string">'autoprefixer'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//开启服务器</span></span><br><span class="line"><span class="keyword">var</span> connect = <span class="built_in">require</span>(<span class="string">"gulp-connect"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> folder = &#123;</span><br><span class="line">    src: <span class="string">"src/"</span>,</span><br><span class="line">    dist: <span class="string">"dist/"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> devMode = process.env.NODE_ENV == <span class="string">"development"</span>;</span><br><span class="line"><span class="comment">//export NODE_ENV=development 设置环境变量</span></span><br><span class="line">task(<span class="string">"html"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//直接输出</span></span><br><span class="line">    <span class="comment">// src(folder.src + "html/*")</span></span><br><span class="line">    <span class="comment">//     .pipe(dest(folder.dist + "html/"))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//压缩输出</span></span><br><span class="line">    src(folder.src + <span class="string">"html/*"</span>)</span><br><span class="line">        .pipe(connect.reload())</span><br><span class="line">        .pipe(htmlclean())</span><br><span class="line">        .pipe(dest(folder.dist + <span class="string">"html/"</span>))</span><br><span class="line">    cb();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">task(<span class="string">"css"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    src(folder.src + <span class="string">"css/*"</span>)</span><br><span class="line">        .pipe(connect.reload()) <span class="comment">//自动刷新的</span></span><br><span class="line">        .pipe(cleanCSS())</span><br><span class="line">        .pipe(dest(folder.dist + <span class="string">"css/"</span>))</span><br><span class="line">    cb();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">task(<span class="string">"less"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    src(folder.src + <span class="string">"less/*"</span>)</span><br><span class="line">        .pipe(less())</span><br><span class="line">        .pipe(postcss([autoprefixer()]))</span><br><span class="line">        .pipe(cleanCSS())</span><br><span class="line">        .pipe(dest(folder.dist + <span class="string">"less/"</span>))</span><br><span class="line">    cb();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">task(<span class="string">"js"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> page = src(folder.src + <span class="string">"js/*"</span>)</span><br><span class="line">        .pipe(stripDebug())</span><br><span class="line">        <span class="keyword">if</span>(!devMode)&#123;<span class="comment">//判断压缩</span></span><br><span class="line">            page.pipe(uglify())</span><br><span class="line">        &#125;</span><br><span class="line">        page.pipe(dest(folder.dist + <span class="string">"js/"</span>))</span><br><span class="line">    cb();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">task(<span class="string">"image"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    src(folder.src + <span class="string">"images/*"</span>)</span><br><span class="line">        .pipe(imageMin())</span><br><span class="line">        .pipe(dest(folder.dist + <span class="string">"images/"</span>))</span><br><span class="line">    cb();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">task(<span class="string">"server"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    connect.server(&#123;</span><br><span class="line">        port: <span class="number">8888</span>,</span><br><span class="line">        livereload: <span class="literal">true</span> <span class="comment">//开启文件变化</span></span><br><span class="line">    &#125;);</span><br><span class="line">    cb();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//监听文件</span></span><br><span class="line">task(<span class="string">"watch"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    watch(folder.src + <span class="string">"html/*"</span>, series(<span class="string">"html"</span>));</span><br><span class="line">    watch(folder.src + <span class="string">"css/*"</span>, series(<span class="string">"css"</span>));</span><br><span class="line">    cb();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">exports.default = series(<span class="string">"html"</span>, <span class="string">"js"</span>, <span class="string">"css"</span>, <span class="string">"less"</span>, <span class="string">"image"</span>, <span class="string">"server"</span>, <span class="string">"watch"</span>);</span><br></pre></td></tr></table></figure>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/JavaScript/">JavaScript</a><a href="/tags/node/">node</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://yoursite.com/2019/12/10/Node-基础知识/" data-title="Node-基础知识 | 110laile" data-tsina class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev">
 <a href="/2020/01/05/JavaScript-ES6/" title="JavaScript-ES6">
  <strong>上一篇：</strong><br>
  <span>
  JavaScript-ES6</span>
</a>
</div>


<div class="next">
<a href="/2019/12/06/理解RESTful架构/" title="理解RESTful架构">
 <strong>下一篇：</strong><br> 
 <span>理解RESTful架构
</span>
</a>
</div>

</nav>

	



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#node-js介绍"><span class="toc-number">1.</span> <span class="toc-text">node.js介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装node-js"><span class="toc-number">2.</span> <span class="toc-text">安装node.js</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#npm"><span class="toc-number">3.</span> <span class="toc-text">npm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#js模块化"><span class="toc-number">4.</span> <span class="toc-text">js模块化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonJs"><span class="toc-number">4.1.</span> <span class="toc-text">CommonJs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AMD"><span class="toc-number">4.2.</span> <span class="toc-text">AMD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CMD"><span class="toc-number">4.3.</span> <span class="toc-text">CMD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Es6"><span class="toc-number">4.4.</span> <span class="toc-text">Es6</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#css模块化-预处理器less"><span class="toc-number">5.</span> <span class="toc-text">css模块化(预处理器less)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在浏览器中使用less"><span class="toc-number">5.1.</span> <span class="toc-text">在浏览器中使用less</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在node中使用less"><span class="toc-number">5.2.</span> <span class="toc-text">在node中使用less</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#less基本语法"><span class="toc-number">5.3.</span> <span class="toc-text">less基本语法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#全局对象和全局变量"><span class="toc-number">6.</span> <span class="toc-text">全局对象和全局变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异步操作"><span class="toc-number">7.</span> <span class="toc-text">异步操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#js执行环境判断"><span class="toc-number">8.</span> <span class="toc-text">js执行环境判断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本模块"><span class="toc-number">9.</span> <span class="toc-text">基本模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fs模块"><span class="toc-number">9.1.</span> <span class="toc-text">fs模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http模块"><span class="toc-number">9.2.</span> <span class="toc-text">http模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#crypto模块"><span class="toc-number">9.3.</span> <span class="toc-text">crypto模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web开发"><span class="toc-number">10.</span> <span class="toc-text">Web开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#koa-Web框架"><span class="toc-number">10.1.</span> <span class="toc-text">koa Web框架</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建Koa工程"><span class="toc-number">10.1.1.</span> <span class="toc-text">创建Koa工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#处理url"><span class="toc-number">10.1.2.</span> <span class="toc-text">处理url</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用Nunjucks"><span class="toc-number">10.1.3.</span> <span class="toc-text">使用Nunjucks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MVC"><span class="toc-number">10.1.4.</span> <span class="toc-text">MVC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql"><span class="toc-number">10.2.</span> <span class="toc-text">mysql</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Sequelize"><span class="toc-number">10.2.1.</span> <span class="toc-text">Sequelize</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#规范化Model"><span class="toc-number">10.2.2.</span> <span class="toc-text">规范化Model</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mocha"><span class="toc-number">10.3.</span> <span class="toc-text">mocha</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#编写测试"><span class="toc-number">10.3.1.</span> <span class="toc-text">编写测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步测试"><span class="toc-number">10.3.2.</span> <span class="toc-text">异步测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Http测试"><span class="toc-number">10.3.3.</span> <span class="toc-text">Http测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行测试"><span class="toc-number">10.3.4.</span> <span class="toc-text">运行测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#webSocket"><span class="toc-number">10.4.</span> <span class="toc-text">webSocket</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ws模块"><span class="toc-number">10.4.1.</span> <span class="toc-text">ws模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mvc中集成websocket"><span class="toc-number">10.4.2.</span> <span class="toc-text">mvc中集成websocket</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#REST"><span class="toc-number">10.5.</span> <span class="toc-text">REST</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#koa处理REST"><span class="toc-number">10.5.1.</span> <span class="toc-text">koa处理REST</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#webpack"><span class="toc-number">11.</span> <span class="toc-text">webpack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#webpack核心概念"><span class="toc-number">11.1.</span> <span class="toc-text">webpack核心概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常用插件及loader"><span class="toc-number">11.2.</span> <span class="toc-text">常用插件及loader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#出入口、loader、插件"><span class="toc-number">11.3.</span> <span class="toc-text">出入口、loader、插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#js-tree-shaking"><span class="toc-number">11.4.</span> <span class="toc-text">js tree shaking</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#css-tree-shaking"><span class="toc-number">11.5.</span> <span class="toc-text">css tree shaking</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#postcss"><span class="toc-number">11.6.</span> <span class="toc-text">postcss</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#htmlwebpackplugin"><span class="toc-number">11.7.</span> <span class="toc-text">htmlwebpackplugin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#提取公共js代码"><span class="toc-number">11.8.</span> <span class="toc-text">提取公共js代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#图片处理"><span class="toc-number">11.9.</span> <span class="toc-text">图片处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开启本地服务器"><span class="toc-number">11.10.</span> <span class="toc-text">开启本地服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#热更新"><span class="toc-number">11.11.</span> <span class="toc-text">热更新</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gulp"><span class="toc-number">12.</span> <span class="toc-text">gulp</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/NET/" title=".NET">.NET<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/Cmd/" title="Cmd">Cmd<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Css/" title="Css">Css<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Docker/" title="Docker">Docker<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Emmet/" title="Emmet">Emmet<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Git/" title="Git">Git<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/HTML/" title="HTML">HTML<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/JQuery/" title="JQuery">JQuery<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/JavaScript/" title="JavaScript">JavaScript<sup>40</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/MongoDB/" title="MongoDB">MongoDB<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Mysql/" title="Mysql">Mysql<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Python/" title="Python">Python<sup>13</sup></a></li>
		  
		
		  
			<li><a href="/categories/Regex/" title="Regex">Regex<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/VisualStudio2017/" title="VisualStudio2017">VisualStudio2017<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Vmware/" title="Vmware">Vmware<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Wpf/" title="Wpf">Wpf<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/css/" title="css">css<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/前端框架/" title="前端框架">前端框架<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>2</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>40</sup></a></li>
			
		
			
				<li><a href="/tags/Python-django/" title="Python django">Python django<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/Html/" title="Html">Html<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/NET-Core简易入门/" title=".NET Core简易入门">.NET Core简易入门<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Mysql/" title="Mysql">Mysql<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Git/" title="Git">Git<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/DevExpress/" title="DevExpress">DevExpress<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Vue/" title="Vue">Vue<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Css/" title="Css">Css<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Docker/" title="Docker">Docker<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/算法/" title="算法">算法<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Html5/" title="Html5">Html5<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/JQuery/" title="JQuery">JQuery<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/包管理/" title="包管理">包管理<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/模块化/" title="模块化">模块化<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/MongoDB/" title="MongoDB">MongoDB<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/NET-FrameWork基础知识/" title=".NET FrameWork基础知识">.NET FrameWork基础知识<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python基础轻松学/" title="Python基础轻松学">Python基础轻松学<sup>1</sup></a></li>
			
		
		</ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer">
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,110laile. <br>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="110laile">110laile</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
